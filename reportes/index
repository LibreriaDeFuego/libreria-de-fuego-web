<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Reportes ‚Äî Librer√≠a de Fuego</title>
<style>
:root{--bg:#0b0c10;--card:#111318;--muted:#9aa3b2;--text:#e7ecf3}
body{margin:0;background:#0b0c10;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif}
header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#0e1116;border-bottom:1px solid #23262f}
a{color:#fff;text-decoration:none}
main{max-width:1100px;margin:0 auto;padding:16px}
.card{background:#111318;border:1px solid #23262f;border-radius:14px;padding:14px}
h1{font-size:18px;margin:0}
label{font-size:12px;color:var(--muted)}
input,select,button{padding:10px;border-radius:10px;border:1px solid #2a2f3a;background:#0f1218;color:#e7ecf3}
button{cursor:pointer;font-weight:600}
.controls{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
table{width:100%;border-collapse:separate;border-spacing:0 8px;margin-top:12px}
th,td{text-align:left;font-size:12px;padding:8px 10px;border-bottom:1px solid #2a2f3a}
.sum{display:flex;gap:16px;flex-wrap:wrap;margin-top:10px;color:#cbd5e1}
.badge{background:#1a1f2b;border:1px solid #2b3344;border-radius:999px;padding:6px 10px}
</style>
</head>
<body>
<header>
  <h1>üìä Reportes ‚Äî Librer√≠a de Fuego</h1>
  <nav><a href="/inventario/">Inventario</a> ¬∑ <a href="/pos/">Caja</a> ¬∑ <a href="/">Inicio</a></nav>
</header>

<main>
  <section class="card">
    <div class="controls">
      <div><label>Desde</label><input type="date" id="from"></div>
      <div><label>Hasta</label><input type="date" id="to"></div>
      <div>
        <label>Grupo</label>
        <select id="groupBy">
          <option value="distribuidor">Distribuidor</option>
          <option value="editorial">Editorial</option>
          <option value="autor">Autor</option>
          <option value="libro">Libro</option>
        </select>
      </div>
      <div style="display:flex;align-items:end;gap:8px">
        <input type="checkbox" id="onlyCons" style="width:auto"><label for="onlyCons">Solo consignaci√≥n</label>
      </div>
      <button id="runBtn">Ver reporte</button>
      <button id="csvBtn">Exportar CSV</button>
    </div>

    <div class="sum" id="summary"></div>
    <table id="tbl">
      <thead><tr id="thead"></tr></thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<script>
/* ===== CONFIG ===== */
const API_URL = "https://script.google.com/macros/s/AKfycbz700j5bneZF5-RiJm8lA7Af1vvXcnkwQnrjYbch3hqEuhMUwtgaBpvIztLwR72bakk/exec";
const IVA=0.19, fmt=n=>new Intl.NumberFormat('es-CL').format(Math.round(n||0));

/* ===== API ===== */
async function apiGet(action, params={}){
  const qs = new URLSearchParams({action, ...params}).toString();
  const r = await fetch(`${API_URL}?${qs}`);
  return r.json();
}
async function apiPost(action, payload){
  const r = await fetch(API_URL,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify({action,...payload})});
  return r.json();
}

/* ===== Data loaders ===== */
async function loadProducts(){
  const r = await apiGet('LIST_PRODUCTS'); if(!r.ok) throw new Error('LIST_PRODUCTS');
  // indexar por code
  const byCode = {};
  for(const p of r.data){
    byCode[p.code] = {
      title: p.title||'',
      editorial: p.editorial||'',
      distribuidor: p.distribuidor||'',
      authors: (p.authors||'').split('|').map(s=>s.trim()).filter(Boolean),
      consignacion: (String(p.consignacion||'').toLowerCase()==='s√≠' || String(p.consignacion||'').toLowerCase()==='si')
    };
  }
  return byCode;
}
async function loadSales(from, to){
  const r = await apiGet('LIST_SALES', { from, to }); if(!r.ok) throw new Error('LIST_SALES');
  return r.data; // [{id,date,method,totalNet,totalTax,total,items:[{code,qty,priceNet,title}]}]
}

/* ===== Reporting ===== */
function aggregate(sales, products, groupBy, onlyCons){
  const agg = new Map(); // key -> {key, qty, net, tax, total}
  const push = (key, qty, net, tax, total)=>{
    const row = agg.get(key) || { key, qty:0, net:0, tax:0, total:0 };
    row.qty += qty; row.net += net; row.tax += tax; row.total += total;
    agg.set(key,row);
  };

  for(const s of sales){
    for(const it of (s.items||[])){
      const p = products[it.code] || {title: it.title||'', editorial:'', distribuidor:'', authors:[], consignacion:false};
      if(onlyCons && !p.consignacion) continue;

      // clave por grupo
      let keys = [];
      if(groupBy==='libro') keys = [`${it.code} ‚Äî ${p.title}`];
      if(groupBy==='editorial') keys = [p.editorial||'(sin editorial)'];
      if(groupBy==='distribuidor') keys = [p.distribuidor||'(sin distribuidor)'];
      if(groupBy==='autor') keys = (p.authors.length? p.authors : ['(sin autor)']);

      const lineNet = (it.priceNet||0) * (it.qty||0);
      const lineTax = lineNet * IVA;
      const lineTot = lineNet * (1+IVA);

      for(const k of keys) push(k, it.qty||0, lineNet, lineTax, lineTot);
    }
  }
  return Array.from(agg.values()).sort((a,b)=> b.total - a.total);
}

function renderTable(rows, groupBy){
  const thead = document.getElementById('thead');
  thead.innerHTML = `<th>${groupBy.toUpperCase()}</th><th>Cant.</th><th>Neto</th><th>IVA</th><th>Total</th>`;
  const tb = document.querySelector('#tbl tbody'); tb.innerHTML='';
  for(const r of rows){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.key}</td><td>${r.qty}</td><td>$${fmt(r.net)}</td><td>$${fmt(r.tax)}</td><td>$${fmt(r.total)}</td>`;
    tb.appendChild(tr);
  }
}

function renderSummary(rows){
  const sum = rows.reduce((a,r)=>({qty:a.qty+r.qty, net:a.net+r.net, tax:a.tax+r.tax, total:a.total+r.total}), {qty:0,net:0,tax:0,total:0});
  document.getElementById('summary').innerHTML = `
    <span class="badge">√çtems: ${fmt(sum.qty)}</span>
    <span class="badge">Neto: $${fmt(sum.net)}</span>
    <span class="badge">IVA: $${fmt(sum.tax)}</span>
    <span class="badge">Total: $${fmt(sum.total)}</span>
  `;
}

function exportCSV(rows, groupBy, from, to){
  const lines = [[groupBy, 'cantidad', 'neto', 'iva', 'total'].join(',')];
  for(const r of rows){
    lines.push([JSON.stringify(r.key), r.qty, Math.round(r.net), Math.round(r.tax), Math.round(r.total)].join(','));
  }
  const blob = new Blob([lines.join('\n')], {type:'text/csv'});
  const a=document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `reporte_${groupBy}_${from||'inicio'}_${to||'hoy'}.csv`;
  a.click();
}

/* ===== UI actions ===== */
document.getElementById('runBtn').onclick = async ()=>{
  const from = document.getElementById('from').value;
  const to   = document.getElementById('to').value;
  const groupBy = document.getElementById('groupBy').value;
  const onlyCons = document.getElementById('onlyCons').checked;

  document.querySelector('#tbl tbody').innerHTML = '<tr><td colspan="5">Cargando‚Ä¶</td></tr>';

  try{
    const [products, sales] = await Promise.all([loadProducts(), loadSales(from, to)]);
    const rows = aggregate(sales, products, groupBy, onlyCons);
    renderTable(rows, groupBy);
    renderSummary(rows);
    window.__lastRows = rows; window.__lastGroup = groupBy; window.__from = from; window.__to = to;
  }catch(e){
    document.querySelector('#tbl tbody').innerHTML = `<tr><td colspan="5">Error: ${e.message}</td></tr>`;
  }
};

document.getElementById('csvBtn').onclick = ()=>{
  if(!window.__lastRows){ alert('Primero genera el reporte'); return; }
  exportCSV(window.__lastRows, window.__lastGroup, window.__from, window.__to);
};
</script>
</body>
</html>
