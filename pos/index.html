<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Caja (POS) ‚Äî Librer√≠a de Fuego ‚Äî Papel & Tinta</title>

<style>
:root{
  --bg:#FFF9EB; --ink:#1F1A17; --sepia:#6A3B2E; --terra:#FF6B4A;
  --green:#00B37E; --line:#FFE3C7; --muted:#7A6A60; --card:#FFFFFF;
  --violet:#8B5CF6; --navy:#1c2353;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
h1,h2,h3{margin:0 0 10px}
a{color:var(--terra);text-decoration:none}
button{cursor:pointer;font-weight:600;border-radius:12px;border:1px solid var(--line);background:#fff;color:var(--ink);padding:10px 12px}
button.primary{background:var(--terra);color:#fff;border-color:#C45F2F}
button.green{background:var(--green);color:#fff;border-color:#276946}
button.ghost{background:#fff;color:var(--sepia)}
button:disabled{opacity:.6;cursor:not-allowed}

.container{max-width:1200px;margin:0 auto;padding:16px}
header .brand{font-size:20px;font-weight:800;letter-spacing:.2px}
.grid{display:grid;gap:14px;grid-template-columns:3fr 1fr;align-items:start}
@media (max-width:980px){ .grid{grid-template-columns:1fr} }

.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 6px 20px rgba(0,0,0,.04)}
.card h2{font-size:16px}

.omniWrap{position:relative}
.omniWrap input{width:100%;padding:14px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;color:#000;font-size:16px}
.suggestBox{position:absolute;left:0;right:0;top:56px;background:#fff;border:1px solid var(--line);border-radius:12px;max-height:360px;overflow:auto;z-index:9999;box-shadow:0 10px 24px rgba(0,0,0,.08)}
.suggestItem{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px;border-radius:10px;cursor:pointer}
.suggestItem:hover,.suggestItem.active{background:#FFF1D7}
.left{display:flex;align-items:center;gap:10px;min-width:0}
.cover{width:42px;height:60px;border-radius:10px;object-fit:cover;background:#EEE;border:1px solid #E8E1D9}
.no-cover{width:42px;height:60px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:#EEE;color:#777;font-weight:700}
.meta{display:flex;flex-direction:column;gap:2px;min-width:0}
.meta .t{font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.meta .a{font-size:12px;color:#737373;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.meta .p{font-size:12px;color:var(--sepia)}
.stock{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid var(--line)}
.stock.good{background:#EFF7F1;border-color:#D5E9DB;color:#246744}
.stock.none{background:#FCEDEA;border-color:#F2C7BB;color:#9A3D1D}

.small{font-size:12px;color:var(--muted)}
.line{display:flex;align-items:center;gap:8px}

table{width:100%;border-collapse:separate;border-spacing:0 8px}
th,td{text-align:left;font-size:12px;padding:10px;border-bottom:1px dashed var(--line);vertical-align:middle}
td input[type="number"], td input[data-a="discValue"]{padding:8px;border-radius:10px;border:1px solid var(--line);background:#fff;color:#000;width:100%}
.seg{display:inline-flex;border:1px solid var(--line);border-radius:10px;overflow:hidden}
.seg button{padding:8px 10px;background:#fff;border:0;color:#000}
.seg button + button{border-left:1px solid var(--line)}
.seg button.active{background:#FFE3BD}
.row-selected{background:#FFF4EE}

.stickyBar{position:fixed;left:0;right:0;bottom:0;z-index:9000;display:flex;align-items:center;justify-content:space-between;gap:8px;background:rgba(250,247,242,.9);backdrop-filter:saturate(1.1) blur(6px);border-top:1px solid var(--line);padding:10px 12px}

#cartTable .seg[data-line]{display:flex;flex:0 0 120px;max-width:120px}
#cartTable .seg[data-line] button{flex:1 1 0;min-width:0;height:34px;padding:0;line-height:1}
#cartTable td input[data-a="discValue"]{max-width:110px}
#cartTable tbody td .line button.ghost{height:34px;display:inline-flex;align-items:center;justify-content:center;border-radius:999px}

/* Sidebar */
.sideDock{position:fixed;left:0;top:0;bottom:0;width:56px;background:#FFFFFF;border-right:1px solid var(--line);z-index:9100;padding:10px 6px;display:flex;flex-direction:column;gap:8px;transition:width .18s ease;box-shadow:0 10px 24px rgba(0,0,0,.04)}
.sideDock:hover{width:200px}
.sideDock .dockItem{display:flex;align-items:center;gap:12px;padding:10px;border-radius:12px;color:var(--ink);border:1px solid transparent;text-decoration:none;white-space:nowrap}
.sideDock .dockItem:hover{background:#FFF4EE;border-color:#EEC8B3}
.sideDock .ico{font-size:18px;width:24px;text-align:center}
.sideDock .lbl{opacity:0;transition:opacity .16s}
.sideDock:hover .lbl{opacity:1}
.container{margin-left:72px}
.navLinks{display:none !important}

/* COBRO */
.cobroCard{background:var(--navy)!important;color:#fff!important;border:none!important;box-shadow:0 6px 20px rgba(0,0,0,.3)}
.cobroCard .small,.cobroCard label,.cobroCard h2{color:#fff!important}
.cobroCard h2{font-size:22px}

/* Botones m√©todo + cortina unida */
#payMethods{display:flex;flex-direction:column;gap:8px}
.payItem{}
.payBtn{
  width:100%;border-color:transparent;background:#fff;color:#000;
  border-radius:16px;font-weight:800;letter-spacing:.5px;
}
.payBtn.active{background:#ff751f;color:#fff}
.payItem.open .payBtn{border-bottom-left-radius:0;border-bottom-right-radius:0}

/* La cortina */
.curtain{
  display:none;overflow:hidden;background:#fff;color:#000;
  border-radius:0 0 16px 16px;
  box-shadow:0 8px 18px rgba(0,0,0,.25);
  transform-origin:top center;
  transition:max-height .25s ease, opacity .2s ease;
  max-height:0; opacity:0;
}
.payItem.open .curtain{display:block;max-height:280px;opacity:1}

.curtain .body{padding:14px 16px}
.curtain .row{display:flex;align-items:center;gap:10px}
.curtain label{font-size:16px;color:#1f1a17;letter-spacing:.4px}
.curtain .money{font-size:22px;font-weight:900}
.curtain input{
  width:160px;border:1px solid #E6E0D8;border-radius:10px;padding:8px 10px;font-size:16px
}

/* Switch Pago dividido ‚Äî peque√±o */
.toggle-switch{position:relative;display:inline-block;width:36px;height:20px}
.toggle-switch input{opacity:0;width:0;height:0}
.slider{position:absolute;inset:0;background:#ccc;border-radius:34px;transition:.3s;cursor:pointer}
.slider:before{content:"";position:absolute;left:3px;bottom:3px;width:14px;height:14px;background:#fff;border-radius:50%;transition:.3s}
.toggle-switch input:checked + .slider{background:#537BFF}
.toggle-switch input:checked + .slider:before{transform:translateX(16px)}

/* Barra split */
#splitBar{height:6px;width:100%;border-radius:10px;background:linear-gradient(to right,#537BFF 100%,#FF70D7 0%)}

/* Chip Total */
.totalChip{
  position:relative;background:#537BFF;color:#fff;
  padding:22px 24px 30px;border-radius:22px;min-width:260px;
  box-shadow:0 10px 22px rgba(0,0,0,.18);text-align:center;
}
.totalChip .t1{position:absolute;top:10px;left:16px;font-size:14px;opacity:.92;margin:0;text-align:left}
.totalChip .t2{font-size:40px;font-weight:900;line-height:1.05;margin:10px 0 16px}
.totalChip .t3{position:absolute;right:16px;bottom:12px;font-size:16px;opacity:.95;font-weight:600}

.link-minimal{background:none;border:0;color:#fff;padding:0;font-weight:700}
.link-minimal:hover{text-decoration:underline;opacity:.9}
</style>
</head>
<body>

<aside class="sideDock" aria-label="Navegaci√≥n principal">
  <a href="inventario.html" class="dockItem" title="Inventario"><span class="ico">üìö</span><span class="lbl">Inventario</span></a>
  <a href="reportes.html" class="dockItem" title="Reportes"><span class="ico">üìä</span><span class="lbl">Reportes</span></a>
  <a href="bodega.html" class="dockItem" title="Bodega"><span class="ico">üè∑Ô∏è</span><span class="lbl">Bodega</span></a>
</aside>

<div class="container">
  <header class="topbar" style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
    <div class="leftBar">
      <div class="brand">üßæ Caja (POS) ‚Äî Librer√≠a de Fuego</div>
    </div>
    <div class="small">Ayuda <button id="helpOpen" class="ghost">?</button></div>
  </header>

  <section class="grid">
    <!-- IZQUIERDA -->
    <div class="card">
      <h2>Detalle de venta</h2>
      <div class="omniWrap" style="margin-top:8px">
        <input id="omniInput" placeholder="Escanea o escribe t√≠tulo, autor o c√≥digo" autocomplete="off">
        <div id="searchResults" class="suggestBox" hidden></div>
      </div>
      <div class="line small" style="margin-top:8px">
        <label class="line"><input id="returnMode" type="checkbox" style="margin-right:6px"> Modo cambio / devoluci√≥n</label>
        <span>‚Ä¢ Doble clic fila: +1 ‚Ä¢ Alt+clic: ‚àí1 ‚Ä¢ Supr: quitar ‚Ä¢ <kbd>/</kbd> enfoca b√∫squeda</span>
      </div>
      <hr class="sep">
      <table id="cartTable"><thead><tr>
        <th style="width:110px">C√≥digo</th><th>T√≠tulo</th><th style="width:140px">Cantidad</th>
        <th style="width:120px">PVP</th><th style="width:300px">Descuento</th><th style="width:120px">Total</th><th style="width:70px"></th>
      </tr></thead><tbody></tbody></table>
      <div class="line" style="margin-top:8px;justify-content:flex-end;gap:10px">
        <button id="retryOutboxBtn" class="ghost" style="display:none">Reintentar pendientes</button>
        <button id="clearBtn" class="ghost">Vaciar</button>
      </div>
    </div>

    <!-- DERECHA: COBRO -->
    <div class="card cobroCard">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <h2>COBRO</h2><button id="menuCobro" style="background:none;border:none;font-size:20px;color:#fff">‚ãÆ</button>
      </div>

      <!-- Descuento -->
      <div class="line" style="margin-top:10px;flex-wrap:wrap">
        <label class="small" style="width:100%">Descuento</label>
        <div class="seg pill" id="genSeg" data-state="percent">
          <div class="switcher"></div>
          <button type="button" class="pill-icon" data-v="amount">$</button>
          <div class="pill-input"><input id="globalDiscValue" type="text" inputmode="numeric" value="0" data-format="money"></div>
          <button type="button" class="pill-percent active" data-v="percent">%</button>
        </div>
        <input id="globalDiscType" type="hidden" value="percent">
      </div>

      <!-- Total -->
      <div class="line" style="margin-top:8px;justify-content:center">
        <div class="totalChip">
          <div class="t1">Total</div>
          <div class="t2">$<span id="grandTotal">0</span></div>
          <div class="t3">Descuento: -$<span id="grandDiscount">0</span></div>
        </div>
      </div>

      <!-- M√©todos + Cortinas -->
      <label class="small" style="margin-top:8px">M√©todo de pago</label>
      <div id="payMethods" style="margin-top:6px">
        <!-- D√âBITO -->
        <div class="payItem" data-method="debito">
          <button class="payBtn" data-method="debito">D√âBITO</button>
          <div class="curtain" data-detail="debito">
            <div class="body">
              <div class="row">
                <label>PAGA CON</label>
                <input id="in_debito" type="text" inputmode="numeric" value="0" data-format="money">
              </div>
            </div>
          </div>
        </div>

        <!-- CR√âDITO -->
        <div class="payItem" data-method="credito">
          <button class="payBtn" data-method="credito">CR√âDITO</button>
          <div class="curtain" data-detail="credito">
            <div class="body">
              <div class="row">
                <label>PAGA CON</label>
                <input id="in_credito" type="text" inputmode="numeric" value="0" data-format="money">
              </div>
            </div>
          </div>
        </div>

        <!-- TRANSFERENCIA -->
        <div class="payItem" data-method="transferencia">
          <button class="payBtn" data-method="transferencia">TRANSFERENCIA</button>
          <div class="curtain" data-detail="transferencia">
            <div class="body">
              <div class="row">
                <label>PAGA CON</label>
                <input id="in_transferencia" type="text" inputmode="numeric" value="0" data-format="money">
              </div>
            </div>
          </div>
        </div>

        <!-- EFECTIVO -->
        <div class="payItem" data-method="efectivo">
          <button class="payBtn" data-method="efectivo">EFECTIVO</button>
          <div class="curtain" data-detail="efectivo">
            <div class="body">
              <div class="row">
                <label>PAGA CON</label>
                <input id="in_efectivo" type="text" inputmode="numeric" value="0" data-format="money">
              </div>
              <div class="row" style="margin-top:8px">
                <label>VUELTO</label>
                <div id="vueltoDisplay" class="money">$0</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Pago dividido -->
      <div class="line" style="align-items:center;justify-content:space-between;margin-top:8px">
        <label class="small">Pago dividido</label>
        <label class="toggle-switch"><input type="checkbox" id="splitToggle"><span class="slider"></span></label>
      </div>
      <div id="splitBar" style="margin-top:6px"></div>

      <hr class="sep" style="opacity:.2;margin-top:12px">
      <div class="line" style="justify-content:flex-end"><button id="saveCartBtn" class="link-minimal">Guardar carro</button></div>
    </div>
  </section>
</div>

<div class="stickyBar" id="stickyBar" aria-live="polite">
  <div><b>Total:</b> $<span id="grandTotalSticky">0</span> ‚Äî <span id="itemsCountSticky">0 √≠tems</span></div>
  <div class="line"><button id="finishBtnSticky" class="green">Cobrar</button><button id="helpOpen2" class="ghost">?</button></div>
</div>

<div id="toasts" aria-live="polite" aria-atomic="true"></div>

<script>
/* ========= Helpers dinero ========= */
const fmt=n=>new Intl.NumberFormat('es-CL').format(Math.round(n||0));
const digitsOnly=v=>(v||'').toString().replace(/\D/g,'');
function readMoney(elOrId){const el=typeof elOrId==='string'?document.getElementById(elOrId):elOrId;if(!el) return 0;const d=digitsOnly(el.value);return d?Number(d):0;}
function setMoneyValue(elOrId,value){const el=typeof elOrId==='string'?document.getElementById(elOrId):elOrId;if(!el)return;const n=Math.max(0,Math.round(Number(value)||0));el.value=fmt(n);}
function formatMoneyInput(el){if(!el)return;const d=digitsOnly(el.value);el.value=d?fmt(Number(d)):'';}
function attachMoneyFormatters(root=document){
  (root instanceof Element?root:document).querySelectorAll('input[data-format="money"]').forEach(el=>{
    if(el.dataset.moneyBound==='1')return;
    formatMoneyInput(el);
    if(el.value===''){el.value='0';}
    el.addEventListener('focus',()=>{ if(readMoney(el)===0){ el.value=''; }});
    el.addEventListener('blur',()=>{ formatMoneyInput(el); if(el.value===''){el.value='0';} });
    el.addEventListener('input',()=>{ const d=digitsOnly(el.value); el.value=d?fmt(Number(d)):''; });
    el.dataset.moneyBound='1';
  });
}

/* ========= Totales (mock m√≠nimo para ejemplo) ========= */
const cart=new Map();
function computeTotals(){ // usa total 6500 para que veas el vuelto del ejemplo si quieres
  let total=0; cart.forEach(it=>{ total+=it; });
  return { totalCompra: Math.max(0,total) };
}
function updateTotalsUI(){
  const t=computeTotals();
  document.getElementById('grandTotal').textContent=fmt(t.totalCompra);
  document.getElementById('grandTotalSticky').textContent=fmt(t.totalCompra);
  document.getElementById('grandDiscount').textContent=fmt(0);
  updateVuelto();
}

/* ========= M√©todos + cortinas ========= */
const splitToggle=document.getElementById('splitToggle');
const splitBar=document.getElementById('splitBar');
const payItems=[...document.querySelectorAll('.payItem')];
const methodsButtons=[...document.querySelectorAll('.payBtn')];
attachMoneyFormatters(document.getElementById('payMethods'));

let activeOrder=[]; // mantiene orden de selecci√≥n

function setActive(method,on){
  const item=document.querySelector(`.payItem[data-method="${method}"]`);
  if(!item) return;
  const btn=item.querySelector('.payBtn');

  if(on){
    if(!btn.classList.contains('active')){
      if(splitToggle.checked && activeOrder.length>=2){
        const first=activeOrder.shift();
        setActive(first,false);
      }
      btn.classList.add('active');
      activeOrder.push(method);
    }
  }else{
    btn.classList.remove('active');
    activeOrder=activeOrder.filter(m=>m!==method);
  }
  updateCurtains();
}
function clearAllActive(){
  methodsButtons.forEach(b=>b.classList.remove('active'));
  activeOrder=[];
  updateCurtains();
}

function updateCurtains(){
  const isSplit=splitToggle.checked;
  payItems.forEach(it=>{
    const m=it.dataset.method;
    const active=activeOrder.includes(m);
    let shouldOpen=false;

    if(m==='efectivo'){
      shouldOpen = active; // efectivo abre siempre cuando est√° activo
    }else{
      shouldOpen = isSplit && active; // otros solo si split activo
    }

    it.classList.toggle('open', shouldOpen);
  });

  splitBar.style.background = isSplit
    ? 'linear-gradient(to right,#FF6B4A 50%,#8B5CF6 50%)'
    : 'linear-gradient(to right,#537BFF 100%,#FF70D7 0%)';

  updateVuelto();
}

methodsButtons.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const method=btn.dataset.method;
    if(splitToggle.checked){
      const on=!btn.classList.contains('active');
      setActive(method,on);
    }else{
      clearAllActive();
      setActive(method,true);
    }
  });
});

splitToggle.addEventListener('change', ()=>{
  if(!splitToggle.checked){
    const keep=activeOrder[activeOrder.length-1];
    clearAllActive();
    if(keep) setActive(keep,true);
  }
  updateCurtains();
});

/* ========= Efectivo: vuelto ========= */
document.getElementById('in_efectivo').addEventListener('input', updateVuelto);
function updateVuelto(){
  const total = computeTotals().totalCompra;
  const pagoEf = readMoney('in_efectivo');
  const vuelto = Math.max(0, pagoEf - total);
  const out=document.getElementById('vueltoDisplay');
  if(out) out.textContent='$'+fmt(vuelto);
}

/* ========= Init ========= */
function initSplitDefaultOff(){
  splitToggle.checked=false;
  clearAllActive();
  setActive('debito',true); // por defecto
  // demo: total fijo para que veas la maqueta (puedes quitarlo)
  cart.set('demo',6500);
  updateTotalsUI();
}
attachMoneyFormatters();
initSplitDefaultOff();
</script>
</body>
</html>
