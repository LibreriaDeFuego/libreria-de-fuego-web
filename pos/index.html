<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Caja (POS) ‚Äî Librer√≠a de Fuego (Cloud) ‚Äî Omnibox</title>
<style>
:root{--bg:#0b0c10;--card:#111318;--muted:#9aa3b2;--text:#e7ecf3;--line:#2a2f3a}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif}
a{color:#fff;text-decoration:none}
button{cursor:pointer;font-weight:600}

/* Layout con sidebar izquierdo */
.layout{display:grid;grid-template-columns:220px 1fr;gap:12px;max-width:1200px;margin:0 auto;padding:12px}
@media (max-width:900px){ .layout{grid-template-columns:1fr} }

aside{position:sticky;top:12px;height:fit-content}
.navbox{background:#0e1116;border:1px solid #23262f;border-radius:14px;padding:12px}
.navbox h1{font-size:18px;margin:0 0 8px}
.nav a{display:block;background:#1a1f2b;border:1px solid #2b3344;border-radius:12px;padding:10px 12px;margin-bottom:8px;font-size:14px}
.nav a:hover{background:#243045}

main{display:grid;gap:12px}

.card{background:#111318;border:1px solid #23262f;border-radius:14px;padding:14px}
h2{font-size:14px;margin:0 0 10px 0}
input,select,button{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0f1218;color:#e7ecf3}
.badge{background:#1a1f2b;border:1px solid #2b3344;border-radius:999px;padding:6px 10px;color:#cbd5e1;font-size:12px}

.inline{display:flex;align-items:center;gap:8px}
.grid{display:grid;gap:10px}
.grid-4{grid-template-columns:1fr 1fr 1fr 1fr}

table{width:100%;border-collapse:separate;border-spacing:0 8px}
th,td{text-align:left;font-size:12px;padding:8px 10px;border-bottom:1px solid var(--line);vertical-align:middle}
td input[type="number"]{padding:6px}
.row-selected{background:#18202f}
.actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
.total{display:flex;justify-content:space-between;align-items:center;font-weight:800;font-size:18px;margin-top:8px}
.small{font-size:12px;color:var(--muted)}

/* --- Omnibox --- */
.omniWrap{position:relative}
.omniWrap input{font-size:16px;padding:14px 12px}
.suggestBox{
  position:absolute; top:54px; left:0; right:0;
  background:#0e1116; border:1px solid #23262f; border-radius:12px;
  padding:6px; max-height:360px; overflow:auto; z-index:9999;
}
@media (max-width:520px){
  .suggestBox{ position:fixed; inset:8px; max-height:none; border-radius:14px; padding:10px }
}
.suggestItem{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  padding:10px; border-radius:10px; cursor:pointer;
}
.suggestItem:hover, .suggestItem.active{background:#1a1f2b}
.suggestItem.no-stock{ background:#2a1b1b; } /* fila completa pintada cuando no hay stock */
.left{display:flex; align-items:center; gap:10px; min-width:0}
.cover{
  width:42px; height:60px; border-radius:10px; object-fit:cover; flex:0 0 auto; background:#1f2430;
}
.no-cover{
  width:42px; height:60px; border-radius:10px; display:flex; align-items:center; justify-content:center;
  background:#1f2430; color:#cbd5e1; font-weight:700;
}
.meta{display:flex; flex-direction:column; gap:2px; min-width:0}
.meta .t{font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
.meta .a{font-size:12px; color:#9aa3b2; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
.meta .p{font-size:12px; color:#cbd5e1}
.stock{font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid #2b3344; color:#cbd5e1}
.stock.good{background:#1b2a1b;border-color:#264b26}
.stock.none{background:#2a1b1b;border-color:#4b2626}

/* --- Segmentador de descuento (botones) --- */
.seg{display:inline-flex; border:1px solid var(--line); border-radius:10px; overflow:hidden}
.seg button{padding:8px 10px; background:#0f1218; border:0; color:#e7ecf3; width:auto}
.seg button + button{border-left:1px solid var(--line)}
.seg button.active{background:#243045}

/* PVP final por l√≠nea */
.finalcu{display:block; font-size:11px; color:#9aa3b2; margin-top:2px}
.tooltip{font-size:11px; color:#9aa3b2}
</style>
</head>
<body>

<div class="layout">
  <!-- Sidebar IZQUIERDO -->
  <aside>
    <div class="navbox">
      <h1>üßæ Caja (POS)</h1>
      <nav class="nav">
        <a href="/">Inicio</a>
        <a href="/inventario/">Inventario</a>
        <a href="/reportes/">Reportes</a>
      </nav>
    </div>
  </aside>

  <!-- CONTENIDO -->
  <main>
    <section class="card">
      <h2>Agregar al carrito</h2>
      <div class="grid grid-4">
        <!-- üîé Omnibox (c√≥digo + b√∫squeda) -->
        <div class="omniWrap" style="grid-column:1 / -1">
          <input id="omniInput" placeholder="Escanea o escribe t√≠tulo, autor o c√≥digo" autocomplete="off">
          <div id="searchResults" class="suggestBox" hidden></div>
        </div>

        <label class="inline" title="Si activas Modo Cambio, las cantidades se agregan negativas (devuelve stock)">
          <input id="returnMode" type="checkbox" style="width:auto"> Modo cambio / devoluci√≥n
        </label>

        <div class="inline small">Doble clic fila: +1 ‚Ä¢ Alt+clic: ‚àí1 ‚Ä¢ Supr: quitar. Escanea o escribe, el campo se limpia y vuelve el foco solo.</div>
      </div>
    </section>

    <section class="card">
      <h2>Carrito</h2>
      <table id="cartTable">
        <thead>
          <tr>
            <th>C√≥digo</th>
            <th>T√≠tulo</th>
            <th>Cantidad</th>
            <th>PVP</th>
            <th>Descuento</th>
            <th>Total</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="grid grid-4" style="margin-top:8px">
        <!-- DESCUENTO GENERAL (sobre PVP) -->
        <div class="inline">
          <label class="small" style="width:140px">Descuento general</label>
          <div class="seg" id="genSeg">
            <button type="button" data-v="percent" class="active">%</button>
            <button type="button" data-v="amount">$</button>
          </div>
          <input id="globalDiscValue" type="number" min="0" value="0" style="max-width:140px">
          <input id="globalDiscType" type="hidden" value="percent">
        </div>

        <!-- M√âTODO DE PAGO 1 -->
        <div class="inline">
          <label class="small" style="width:80px">Pago 1</label>
          <select id="payMethod1">
            <option value="efectivo">Efectivo</option>
            <option value="debito">D√©bito</option>
            <option value="credito">Cr√©dito</option>
            <option value="transferencia">Transferencia</option>
          </select>
        </div>

        <!-- Paga con / vuelto para m√©todo 1 -->
        <div class="inline" id="cashBox1" style="display:none">
          <label class="small" style="width:100px">Paga con</label>
          <input id="cashGiven1" type="number" min="0" value="0" style="max-width:160px">
          <span class="badge">Vuelto: $<span id="cashChange1">0</span></span>
        </div>

        <div class="inline">
          <label class="small"><input id="splitToggle" type="checkbox" style="width:auto"> Dividir pago</label>
        </div>
      </div>

      <!-- Split payment section -->
      <div id="splitSection" class="grid grid-4" style="margin-top:8px; display:none">
        <div class="inline">
          <label class="small" style="width:80px">Monto 1</label>
          <input id="amount1" type="number" min="0" value="0">
        </div>

        <div class="inline">
          <label class="small" style="width:80px">Pago 2</label>
          <select id="payMethod2">
            <option value="debito">D√©bito</option>
            <option value="credito">Cr√©dito</option>
            <option value="transferencia">Transferencia</option>
            <option value="efectivo">Efectivo</option>
          </select>
        </div>

        <div class="inline">
          <label class="small" style="width:80px">Monto 2</label>
          <input id="amount2" type="number" min="0" value="0">
        </div>

        <div class="inline" id="cashBox2" style="display:none">
          <label class="small" style="width:100px">Paga con (2)</label>
          <input id="cashGiven2" type="number" min="0" value="0" style="max-width:160px">
          <span class="badge">Vuelto(2): $<span id="cashChange2">0</span></span>
        </div>
      </div>

      <div class="actions">
        <button id="retryOutboxBtn" style="display:none" title="Reenviar ventas pendientes">Reintentar pendientes</button>
        <button id="finishBtn">Cobrar / Ticket</button>
        <button id="reprintBtn" title="Reimprimir √∫ltimo ticket">Reimprimir</button>
        <button id="clearBtn">Vaciar</button>
      </div>

      <!-- RESUMEN SIMPLIFICADO -->
      <div class="total">
        <span id="itemsCount">0 √≠tems</span>
        <span>
          <span class="badge">Descuentos totales: $<span id="sumAllDiscounts">0</span></span>
          <span class="badge">Total de compra: $<span id="grandTotal">0</span></span>
        </span>
      </div>
    </section>
  </main>
</div>

<script>
/* ====== CONFIG ====== */
const API_URL = "https://script.google.com/macros/s/AKfycbz700j5bneZF5-RiJm8lA7Af1vvXcnkwQnrjYbch3hqEuhMUwtgaBpvIztLwR72bakk/exec";

/* ====== Helpers & API ====== */
const IVA=0.19; // solo para convertir priceNet -> PVP al leer, luego NO se usa
const fmt=n=>new Intl.NumberFormat('es-CL').format(Math.round(n||0));
async function apiGet(action){
  const r=await fetch(`${API_URL}?action=${encodeURIComponent(action)}`,{mode:'cors',credentials:'omit'});
  return r.json();
}
async function apiPost(action,payload){
  const r=await fetch(API_URL,{
    method:'POST',mode:'cors',credentials:'omit',
    headers:{'Content-Type':'text/plain;charset=utf-8'},
    body:JSON.stringify({action,...payload})
  });
  return r.json();
}

/* ====== Cache productos ====== */
const CACHE_TTL_MS = 10*60*1000; // 10 minutos
let productCache = null;
(function initCacheFromLS(){
  try{
    const raw = localStorage.getItem('pos_products_cache');
    if(raw){ const {ts, arr} = JSON.parse(raw); productCache = {ts, arr}; }
  }catch{}
})();
async function loadProductsCached(){
  try{
    if(productCache && (Date.now()-productCache.ts)<CACHE_TTL_MS) return productCache.arr;
    const arr = await cloudGetProducts();
    productCache = {ts: Date.now(), arr};
    try{ localStorage.setItem('pos_products_cache', JSON.stringify({ts:productCache.ts, arr})); }catch{}
    return arr;
  }catch(err){
    alert('No se pudo cargar productos (LIST_PRODUCTS). Reintenta.'); throw err;
  }
}

/* ====== Cloud ====== */
function getAuthorField(p){
  let a = p.author ?? p.autor ?? p.autores ?? p.Author ?? p.Autor ?? p.authors ?? p.writer ?? p.creador ?? p.creators ?? '';
  if(Array.isArray(a)) a = a.map(x => (x?.name||x)).join(', ');
  if(a && typeof a === 'object') a = a.name || a.fullname || a.display || '';
  return String(a||'');
}
function getCoverField(p){
  let c = p.cover ?? p.image ?? p.coverUrl ?? p.portada ?? p.portadaUrl ?? p.thumbnail ?? '';
  return String(c||'');
}
async function cloudGetProducts(){
  const r = await apiGet('LIST_PRODUCTS'); if(!r.ok) throw new Error('LIST_PRODUCTS');
  return r.data.map(p=>({
    code  : String(p.code),
    title : String(p.title||p.Titulo||p.titulo||'Sin t√≠tulo'),
    author: getAuthorField(p),
    cover : getCoverField(p),
    pricePVP: Number(p.priceNet||0) * (1+IVA), // SOLO para UI/boleta
    stock : Number(p.stock||p.Stock||0)
  }));
}
async function cloudRegisterSale(sale){
  const r = await apiPost('REGISTER_SALE', { sale });
  if(!r.ok) throw new Error(r?.message || 'REGISTER_SALE');
  return r.data; // { saleId }
}

/* ====== POS state ====== */
const cart=new Map();
let lastTicketHTML='';
let selectedCode=null;        // para Supr
let lastScan = {code:'', at:0}; // anti-doble escaneo
function focusOmni(){ const el=document.getElementById('omniInput'); el?.focus(); el?.select?.(); }

function addOrInc(code, product){
  const negative = document.getElementById('returnMode').checked;
  const delta = negative ? -1 : 1;
  const it = cart.get(code) || {code:product.code,title:product.title,pricePVP:product.pricePVP,qty:0,discType:'none',discValue:0};
  it.qty += delta;
  if (it.qty === 0) cart.delete(code); else cart.set(code,it);
  renderCart();
}

async function addByCode(code){
  const now = Date.now();
  if(lastScan.code===code && (now - lastScan.at) < 500) { return; } // anti-doble
  lastScan = {code, at: now};

  const products=await loadProductsCached();
  const p=products.find(r=>r.code===code);
  if(!p){ alert('C√≥digo no encontrado'); return; }
  if((p.stock||0)<=0 && !document.getElementById('returnMode').checked){
    if(!confirm('Sin stock. ¬øAgregar igualmente?')) return;
  }
  addOrInc(code, p);
}

/* ====== C√°lculos SOBRE PVP ====== */
function computeLine(it){
  const unit = Number(it.pricePVP||0);
  const qty  = Number(it.qty||0);
  let unitAfter = unit;
  if(it.discType==='percent'){
    unitAfter = unit * (1 - (Number(it.discValue||0)/100));
  }else if(it.discType==='amount'){
    unitAfter = Math.max(0, unit - Number(it.discValue||0));
  }
  const base = unit * qty;
  const descLine = base - unitAfter * qty;
  const total = unitAfter * qty;
  return {unit, unitAfter, base, descLine, total};
}

function computeTotals(){
  let subtotal=0, descLineas=0;
  for(const it of cart.values()){
    const c = computeLine(it);
    subtotal += c.total;
    descLineas += c.descLine;
  }
  const type = document.getElementById('globalDiscType').value;
  const val  = Number(document.getElementById('globalDiscValue').value||0);

  let descGeneral = 0;
  if(type==='percent') descGeneral = subtotal * (val/100);
  else if(type==='amount') descGeneral = Math.min(subtotal, val);

  const descuentosTotales = Math.max(0, descLineas + descGeneral);
  const totalCompra = Math.max(0, subtotal - descGeneral);

  return { subtotal, descLineas, descGeneral, descuentosTotales, totalCompra };
}

/* === util: refrescar s√≥lo badges y vuelto, sin redibujar tabla === */
function updateTotalsUI(){
  const t=computeTotals();
  document.getElementById('sumAllDiscounts').textContent=fmt(t.descuentosTotales);
  document.getElementById('grandTotal').textContent=fmt(t.totalCompra);
  updateChangeDisplays();
}

/* ====== Render ====== */
function renderCart(){
  const tb=document.querySelector('#cartTable tbody'); tb.innerHTML='';
  for(const it of cart.values()){
    const c=computeLine(it);
    const tr=document.createElement('tr');
    tr.title = 'Doble clic: +1 ‚Ä¢ Alt+clic: ‚àí1 ‚Ä¢ Supr: quitar';
    tr.dataset.code = it.code;
    tr.innerHTML=`
      <td>${it.code}</td>
      <td>${it.title}</td>
      <td class="inline" style="gap:6px">
        <button data-a="dec" data-code="${it.code}" style="width:auto;padding:6px 10px">‚àí</button>
        <span>${it.qty}</span>
        <button data-a="inc" data-code="${it.code}" style="width:auto;padding:6px 10px">+</button>
      </td>
      <td>
        $${fmt(it.pricePVP)}
        ${ (it.discType!=='none' && Number(it.discValue)>0) ? `<span class="finalcu">Final c/u: $${fmt(c.unitAfter)}</span>` : '' }
      </td>
      <td>
        <div class="inline" style="gap:6px;justify-content:flex-end">
          <div class="seg" data-line="${it.code}">
            <button type="button" data-a="discType" data-v="percent" class="${it.discType==='percent'?'active':''}">%</button>
            <button type="button" data-a="discType" data-v="amount"  class="${it.discType==='amount'?'active':''}">$</button>
            <button type="button" data-a="discNone"  class="${it.discType==='none'?'active':''}">sin</button>
          </div>
          <input type="number" min="0" value="${it.discValue||0}" data-a="discValue" data-code="${it.code}" style="max-width:110px" />
        </div>
      </td>
      <td class="lineTotal">$${fmt(c.total)}</td>
      <td><button data-a="del" data-code="${it.code}">Quitar</button></td>`;
    tb.appendChild(tr);

    // selecci√≥n y atajos
    tr.onclick = (ev)=>{ 
      document.querySelectorAll('#cartTable tbody tr').forEach(r=>r.classList.remove('row-selected'));
      tr.classList.add('row-selected'); selectedCode = it.code;
      if(ev.altKey){ const item=cart.get(it.code); if(item){ item.qty--; if(item.qty===0) cart.delete(it.code); renderCart(); } }
    };
    tr.ondblclick = ()=>{ const item=cart.get(it.code); if(item){ item.qty++; renderCart(); } };
  }

  // botones inc/dec/del
  tb.querySelectorAll('button').forEach(b=>{
    const code=b.dataset.code, a=b.dataset.a;
    b.onclick=()=>{
      const it=cart.get(code); if(!it) return;
      if(a==='inc') it.qty++;
      if(a==='dec') it.qty=(it.qty>0?it.qty-1:it.qty-1);
      if(a==='del') cart.delete(code);
      renderCart();
    };
  });

  // botones de tipo de descuento por l√≠nea (sin re-render global)
  tb.querySelectorAll('.seg[data-line]').forEach(seg=>{
    seg.addEventListener('click', (e)=>{
      if(e.target.tagName!=='BUTTON') return;
      const code = seg.dataset.line;
      const it = cart.get(code); if(!it) return;
      const act = e.target.dataset.a;
      seg.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
      e.target.classList.add('active');
      if(act==='discType'){
        it.discType = e.target.dataset.v;
        if(!it.discValue) it.discValue = (it.discType==='percent'?1:100);
      }else if(act==='discNone'){
        it.discType = 'none';
        it.discValue = 0;
      }
      const row = seg.closest('tr');
      const c = computeLine(it);
      row.querySelector('.lineTotal').textContent = '$'+fmt(c.total);
      const priceTd = row.children[3];
      priceTd.innerHTML = '$'+fmt(it.pricePVP)+( (it.discType!=='none' && Number(it.discValue)>0) ? `<span class="finalcu">Final c/u: $${fmt(c.unitAfter)}</span>` : '' );
      updateTotalsUI();
    });
  });

  // input valor descuento por l√≠nea
  tb.querySelectorAll('input[data-a="discValue"]').forEach(el=>{
    el.oninput=()=>{
      const code=el.dataset.code; const it=cart.get(code); if(!it) return;
      it.discValue = Math.max(0, Number(el.value||0));
      if(it.discType==='none' && it.discValue>0){
        const seg = el.closest('tr').querySelector('.seg[data-line]');
        seg.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
        seg.querySelector('button[data-v="percent"]').classList.add('active');
        it.discType='percent';
      }
      const row = el.closest('tr');
      const c = computeLine(it);
      row.querySelector('.lineTotal').textContent = '$'+fmt(c.total);
      const priceTd = row.children[3];
      priceTd.innerHTML = '$'+fmt(it.pricePVP)+( (it.discType!=='none' && Number(it.discValue)>0) ? `<span class="finalcu">Final c/u: $${fmt(c.unitAfter)}</span>` : '' );
      updateTotalsUI();
    };
  });

  // Totales y conteos
  const t=computeTotals();
  document.getElementById('sumAllDiscounts').textContent=fmt(t.descuentosTotales);
  document.getElementById('grandTotal').textContent=fmt(t.totalCompra);
  const count = Array.from(cart.values()).reduce((a,it)=>a+Math.abs(it.qty),0);
  document.getElementById('itemsCount').textContent=`${count} √≠tems`;

  updateChangeDisplays();
}

/* ====== Pago y vuelto (incluye split) ====== */
function updateChangeDisplays(){
  const total = computeTotals().totalCompra;

  const method1 = document.getElementById('payMethod1').value;
  const split = document.getElementById('splitToggle').checked;
  const cashBox1 = document.getElementById('cashBox1');
  const cashBox2 = document.getElementById('cashBox2');
  cashBox1.style.display = (method1==='efectivo') ? 'flex' : 'none';

  if(!split){
    const given1 = Number(document.getElementById('cashGiven1').value||0);
    const change1 = Math.max(0, (method1==='efectivo' ? given1 : 0) - total);
    document.getElementById('cashChange1').textContent = fmt(change1);
    document.getElementById('splitSection').style.display='none';
    return;
  }

  document.getElementById('splitSection').style.display='grid';
  const method2 = document.getElementById('payMethod2').value;
  cashBox2.style.display = (method2==='efectivo') ? 'flex' : 'none';

  const a1 = Math.max(0, Number(document.getElementById('amount1').value||0));
  const a2 = Math.max(0, Number(document.getElementById('amount2').value||0));
  const g1 = Number(document.getElementById('cashGiven1').value||0);
  const g2 = Number(document.getElementById('cashGiven2').value||0);

  const cashPaid = (method1==='efectivo'?g1:0) + (method2==='efectivo'?g2:0);
  const nonCashPaid = (method1!=='efectivo'?a1:0) + (method2!=='efectivo'?a2:0);
  const change = Math.max(0, cashPaid + nonCashPaid - total);

  document.getElementById('cashChange1').textContent = fmt(method1==='efectivo' ? Math.max(0, g1 - (a1 || 0)) : 0);
  document.getElementById('cashChange2').textContent = fmt(method2==='efectivo' ? Math.max(0, g2 - (a2 || 0)) : 0);
}

/* ====== Ticket (solo PVP) ====== */
function buildTicketHTML(saleId, items, sums, payments, isReturn){
  const lines = items.map(it=>{
    const {unitAfter} = computeLine(it);
    const d = it.discType==='percent' ? ` (-${it.discValue}% )` :
              it.discType==='amount'  ? ` (-$${fmt(it.discValue)} c/u)` : '';
    return `${it.qty} x ${it.title} ‚Äî $${fmt(unitAfter)}${d}`;
  }).join('<br>');

  const title = isReturn ? 'Ticket de Cambio' : 'Ticket de Venta';
  const payText = payments.map(p=> `${p.method}: $${fmt(p.amount)}${p.cashGiven?` (paga con $${fmt(p.cashGiven)})`:''}`).join(' ¬∑ ');

  return `<!doctype html><html><head><meta charset='utf-8'><title>${title}</title>
    <style>body{font-family:monospace;padding:8px}h1{font-size:16px;margin:0 0 6px}
    hr{border:none;border-top:1px dashed #888;margin:6px 0}</style></head>
    <body>
      <h1>Librer√≠a de Fuego</h1>
      <div>${title} #${saleId} ‚Äî ${new Date().toLocaleString('es-CL')}</div>
      <hr>${lines}<hr>
      <div>Descuentos totales: $${fmt(sums.descuentosTotales)}</div>
      <div><b>Total de compra: $${fmt(sums.totalCompra)}</b></div>
      <div>Pago: ${payText}</div>
      <hr><small>Gracias por tu compra</small>
    </body></html>`;
}

/* ====== Omnibox: detecci√≥n de c√≥digo + b√∫squeda ====== */
const omni = document.getElementById('omniInput');
const results = document.getElementById('searchResults');
let suggIndex = -1;
function hideSuggestions(){ results.hidden = true; suggIndex=-1; }
function showSuggestions(){ results.hidden = false; }

const norm = s => (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();

// Checksums
function ean13valid(d){
  if(!/^\d{13}$/.test(d)) return false;
  const a = d.split('').map(Number);
  const sum = a.slice(0,12).reduce((acc,n,i)=> acc + (i%2? n*3 : n), 0);
  const check = (10 - (sum % 10)) % 10;
  return check === a[12];
}
function ean8valid(d){
  if(!/^\d{8}$/.test(d)) return false;
  const a = d.split('').map(Number);
  const sum = a.slice(0,7).reduce((acc,n,i)=> acc + (i%2? n*3 : n), 0);
  const check = (10 - (sum % 10)) % 10;
  return check === a[7];
}
function isCodeLike(s){
  const d = s.replace(/[^\d]/g,'');
  if(/^97[89]\d{10}$/.test(d) && ean13valid(d)) return {ok:true, code:d};
  if(/^\d{13}$/.test(d) && ean13valid(d)) return {ok:true, code:d};
  if(/^\d{12}$/.test(d)) return {ok:true, code:d}; // UPC-A (sin checksum estricto)
  if(/^\d{8}$/.test(d) && ean8valid(d)) return {ok:true, code:d};
  return {ok:false};
}

// Scoring b√∫squeda (t√≠tulo/autor)
function lev(a,b){
  a=norm(a); b=norm(b);
  const m=a.length, n=b.length; if(m===0) return n; if(n===0) return m;
  const dp=new Array(n+1); for(let j=0;j<=n;j++) dp[j]=j;
  for(let i=1;i<=m;i++){
    let prev=dp[0], cur; dp[0]=i;
    for(let j=1;j<=n;j++){
      const cost = a[i-1]===b[j-1] ? 0 : 1;
      cur = Math.min(dp[j]+1, dp[j-1]+1, prev+cost);
      prev = dp[j]; dp[j]=cur;
    }
  }
  return dp[n];
}
function scoreParts(p, q){
  const T=norm(p.title), A=norm(p.author), Q=norm(q);
  let titleScore = 0, authorScore = 0;
  if(T.startsWith(Q)) titleScore += 100; else if(T.includes(Q)) titleScore += 70;
  if(A.startsWith(Q)) authorScore+= 100; else if(A.includes(Q)) authorScore+= 70;
  const dt = lev(T.slice(0,32), Q.slice(0,32)); if(dt<=2) titleScore += (50 - dt*10);
  const da = lev(A.slice(0,32), Q.slice(0,32)); if(da<=2) authorScore+= (50 - da*10);
  const total = Math.max(titleScore, authorScore);
  const matched = authorScore>titleScore ? 'author' : 'title';
  return {total, matched};
}
function stockBadge(p){
  const s = Number(p.stock||0);
  if(s<=0) return '<span class="stock none">Sin stock</span>';
  return `<span class="stock good">Stock: ${s}</span>`;
}
function renderSuggestions(list){
  results.innerHTML = '';
  if(list.length===0){ hideSuggestions(); return; }
  list.forEach((p, i)=>{
    const row = document.createElement('div');
    row.className = 'suggestItem' + (i===suggIndex ? ' active' : '') + ( (p.stock||0)<=0 ? ' no-stock' : '' );
    const left = document.createElement('div'); left.className='left';
    let coverEl;
    if(p.cover){ coverEl = document.createElement('img'); coverEl.className='cover'; coverEl.src=p.cover; coverEl.alt=p.title; }
    else{ coverEl = document.createElement('div'); coverEl.className='no-cover'; coverEl.textContent=(p.title||'?').slice(0,1).toUpperCase(); }
    const meta = document.createElement('div'); meta.className='meta';
    meta.innerHTML = `
      <div class="t">${p.title||'Sin t√≠tulo'}</div>
      <div class="a">${p.author||'Autor desconocido'}</div>
      <div class="p">$${fmt(p.pricePVP)}</div>
    `;
    left.appendChild(coverEl); left.appendChild(meta);
    row.appendChild(left);
    const right = document.createElement('div'); right.innerHTML = stockBadge(p);
    row.appendChild(right);

    row.onmousedown = (e)=>{ e.preventDefault(); addOrInc(p.code, p); hideSuggestions(); omni.value=''; focusOmni(); };
    results.appendChild(row);
  });
  showSuggestions();
}

// Omnibox handlers
omni.addEventListener('keydown', (e)=>{
  if(e.key==='Enter'){
    e.preventDefault();
    const raw = omni.value.trim();
    const val = raw.replace(/\s+/g,'');
    const codeChk = isCodeLike(val);
    if(codeChk.ok){
      addByCode(codeChk.code).then(()=>{ omni.value=''; hideSuggestions(); focusOmni(); });
      return;
    }
    const rows = Array.from(results.children);
    if(!results.hidden && rows.length>0){
      rows[0].dispatchEvent(new MouseEvent('mousedown', {bubbles:true}));
    }else{
      doSearch(val);
    }
  }else if(e.key==='Escape'){
    hideSuggestions();
  }
});
omni.addEventListener('input', ()=>{
  const q = omni.value.trim();
  if(q.length<1){ hideSuggestions(); return; }
  // si parece c√≥digo (todo n√∫meros y largo t√≠pico) no mostrar sugerencias a√∫n
  const d = q.replace(/[^\d]/g,'');
  if(d.length>=8 && d.length<=13){ return; }
  doSearch(q);
});
let searchTimer=null;
async function doSearch(q){
  clearTimeout(searchTimer);
  searchTimer = setTimeout(async ()=>{
    const products = await loadProductsCached();
    const sorted = products
      .map(p=>{ const sp = scoreParts(p, q); return {p, s: sp.total, matched: sp.matched}; })
      .filter(x=>x.s>0)
      .sort((a,b)=> b.s - a.s || a.p.title.localeCompare(b.p.title))
      .slice(0, 20)
      .map(x=>x.p);
    renderSuggestions(sorted);
  }, 200);
}
document.addEventListener('click', (e)=>{
  if(!results.contains(e.target) && e.target!==omni){ hideSuggestions(); }
});

/* ====== Eventos generales ====== */
// Descuento general: segmentador (sin re-render global)
const genSeg = document.getElementById('genSeg');
genSeg?.addEventListener('click', (e)=>{
  if(e.target.tagName!=='BUTTON') return;
  genSeg.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
  e.target.classList.add('active');
  const v = e.target.dataset.v; // 'percent' | 'amount'
  document.getElementById('globalDiscType').value = v;
  updateTotalsUI();
});
document.getElementById('globalDiscValue').addEventListener('input', updateTotalsUI);

// Split toggle
document.getElementById('splitToggle').addEventListener('change', ()=>{
  const total = computeTotals().totalCompra;
  document.getElementById('amount1').value = total;
  document.getElementById('amount2').value = 0;
  updateChangeDisplays();
});

// Inputs que cambian c√°lculo de vuelto/montos
['payMethod1','cashGiven1','payMethod2','cashGiven2','amount1','amount2'].forEach(id=>{
  const el=document.getElementById(id);
  el?.addEventListener('input', ()=> updateChangeDisplays());
});

// Confirmaci√≥n al vaciar
document.getElementById('clearBtn').onclick=()=>{
  if(confirm('¬øVaciar el carrito?')){ cart.clear(); renderCart(); focusOmni(); }
};

// Supr para quitar fila seleccionada
document.addEventListener('keydown',(e)=>{
  if(e.key==='Delete' && selectedCode){ cart.delete(selectedCode); selectedCode=null; renderCart(); }
});

/* ====== Cola offline ====== */
function getOutbox(){ try{ return JSON.parse(localStorage.getItem('pos_outbox')||'[]'); }catch{ return []; } }
function setOutbox(arr){ try{ localStorage.setItem('pos_outbox', JSON.stringify(arr)); }catch{} }
function updateOutboxUI(){
  const count = getOutbox().length;
  document.getElementById('retryOutboxBtn').style.display = count>0 ? 'inline-flex' : 'none';
}
async function processOutbox(){
  const q = getOutbox();
  if(q.length===0) return;
  const remaining=[];
  for(const sale of q){
    try{
      await cloudRegisterSale(sale.payload);
    }catch{
      remaining.push(sale);
    }
  }
  setOutbox(remaining);
  updateOutboxUI();
}
setInterval(processOutbox, 30000);
document.getElementById('retryOutboxBtn').onclick=processOutbox;

/* ====== Cobro ====== */
document.getElementById('finishBtn').onclick=async ()=>{
  if(cart.size===0){ alert('Carrito vac√≠o'); focusOmni(); return; }
  const sums = computeTotals();
  const split = document.getElementById('splitToggle').checked;

  let payments = [];
  const m1 = document.getElementById('payMethod1').value;
  if(!split){
    const cash1 = Number(document.getElementById('cashGiven1').value||0);
    payments.push({method: m1, amount: sums.totalCompra, cashGiven: (m1==='efectivo'?cash1:undefined)});
  }else{
    const m2 = document.getElementById('payMethod2').value;
    const a1 = Math.max(0, Number(document.getElementById('amount1').value||0));
    const a2 = Math.max(0, Number(document.getElementById('amount2').value||0));
    const cash1 = Number(document.getElementById('cashGiven1').value||0);
    const cash2 = Number(document.getElementById('cashGiven2').value||0);

    const sum = a1 + a2;
    if(Math.abs(sum - sums.totalCompra) > 1){
      alert('La suma de montos (pago dividido) debe ser igual al Total de compra.');
      return;
    }
    payments.push({method:m1, amount:a1, cashGiven:(m1==='efectivo'?cash1:undefined)});
    payments.push({method:m2, amount:a2, cashGiven:(m2==='efectivo'?cash2:undefined)});
  }

  const items=[];
  for(const it of cart.values()){
    items.push({
      code: it.code, title: it.title, qty: it.qty,
      priceGross: it.pricePVP,
      discType: it.discType, discValue: Number(it.discValue||0)
    });
  }

  const payload = { items, payments, total: sums.totalCompra, discounts: sums.descuentosTotales, returnMode: document.getElementById('returnMode').checked };

  try{
    const resp = await cloudRegisterSale(payload);
    const saleId = resp.saleId || ('LOCAL-' + Date.now());
    const html = buildTicketHTML(saleId, items, sums, payments, payload.returnMode);
    lastTicketHTML = html;
    const w=window.open('','_blank','width=430,height=640'); w.document.write(html); w.document.close(); w.print();

    cart.clear(); renderCart(); focusOmni();
    alert(payload.returnMode ? 'Cambio registrado ‚úÖ' : 'Venta registrada en la nube ‚úÖ');
  }catch(err){
    const q = getOutbox();
    q.push({ts:Date.now(), payload});
    setOutbox(q); updateOutboxUI();
    alert('Sin conexi√≥n o error de servidor. Venta guardada offline y se reintentar√° autom√°ticamente.');
  }
};

document.getElementById('reprintBtn').onclick=()=>{
  if(!lastTicketHTML){ alert('A√∫n no hay ticket para reimprimir'); return; }
  const w=window.open('','_blank','width=430,height=640'); w.document.write(lastTicketHTML); w.document.close(); w.print();
};

// Inicial
renderCart(); focusOmni(); updateOutboxUI(); processOutbox();
</script>
</body>
</html>
