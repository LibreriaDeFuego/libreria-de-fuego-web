<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Caja (POS) ‚Äî Librer√≠a de Fuego (Cloud)</title>
<style>
:root{--bg:#0b0c10;--card:#111318;--muted:#9aa3b2;--text:#e7ecf3}
body{margin:0;background:#0b0c10;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif}
header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#0e1116;border-bottom:1px solid #23262f}
a{color:#fff;text-decoration:none}
main{max-width:980px;margin:0 auto;padding:16px}
.card{background:#111318;border:1px solid #23262f;border-radius:14px;padding:14px}
h1{font-size:18px;margin:0}
h2{font-size:14px;margin:0 0 10px 0}
input,select,button{width:100%;padding:10px;border-radius:10px;border:1px solid #2a2f3a;background:#0f1218;color:#e7ecf3}
button{cursor:pointer;font-weight:600}
.row{display:grid;grid-template-columns:1fr 140px;gap:10px}
.grid{display:grid;gap:10px}
.grid-3{grid-template-columns:1fr 1fr 1fr}
.grid-4{grid-template-columns:1fr 1fr 1fr 1fr}
table{width:100%;border-collapse:separate;border-spacing:0 8px}
th,td{text-align:left;font-size:12px;padding:8px 10px;border-bottom:1px solid #2a2f3a;vertical-align:middle}
.total{display:flex;justify-content:space-between;align-items:center;font-weight:800;font-size:18px;margin-top:8px}
.badge{background:#1a1f2b;border:1px solid #2b3344;border-radius:999px;padding:6px 10px;color:#cbd5e1;font-size:12px}
.small{font-size:12px;color:#9aa3b2}
.inline{display:flex;align-items:center;gap:8px}
td input[type="number"]{padding:6px}
td select{padding:6px}
.actions{display:flex;gap:10px;flex-wrap:wrap}
</style>
</head>
<body>
<header>
  <h1>üßæ Caja (POS) ‚Äî Librer√≠a de Fuego</h1>
  <nav class="inline">
    <a class="badge" href="/inventario/">Inventario</a>
    <a class="badge" href="/reportes/">Reportes</a>
    <a class="badge" href="/">Inicio</a>
  </nav>
</header>

<main>
  <section class="card">
    <h2>Agregar al carrito</h2>
    <div class="grid grid-4">
      <div class="inline" style="gap:10px">
        <input id="scanInput" placeholder="Escanea o escribe c√≥digo/ISBN">
        <button id="scanBtn" style="width:auto">Agregar</button>
      </div>
      <div class="inline" style="gap:10px">
        <input id="searchTitle" placeholder="Buscar por t√≠tulo">
        <button id="pickBtn" style="width:auto">A√±adir</button>
      </div>
      <label class="inline" title="Si activas Modo Cambio, las cantidades se agregan negativas (devuelve stock)">
        <input id="returnMode" type="checkbox" style="width:auto"> Modo cambio / devoluci√≥n
      </label>
      <div class="inline small">Tip: con el lector basta escanear, se agrega solo y el foco vuelve al campo.</div>
    </div>
  </section>

  <section class="card" style="margin-top:12px">
    <h2>Carrito</h2>
    <table id="cartTable">
      <thead>
        <tr>
          <th>C√≥digo</th><th>T√≠tulo</th><th>Cant.</th>
          <th>Neto unit.</th>
          <th>Desc. tipo</th><th>Desc. valor</th>
          <th>Neto l√≠nea</th><th>IVA</th><th>Total</th>
          <th></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="grid grid-4" style="margin-top:8px">
      <div class="inline">
        <label class="small" style="width:110px">Desc. general</label>
        <select id="globalDiscType" style="width:120px">
          <option value="none">Ninguno</option>
          <option value="percent">% (sobre neto)</option>
          <option value="amount">$ (al neto)</option>
        </select>
        <input id="globalDiscValue" type="number" min="0" value="0" style="max-width:140px">
      </div>

      <div class="inline">
        <label class="small" style="width:80px">Pago</label>
        <select id="payMethod">
          <option value="efectivo">Efectivo</option>
          <option value="debito">D√©bito</option>
          <option value="credito">Cr√©dito</option>
          <option value="transferencia">Transferencia</option>
        </select>
      </div>

      <div class="inline" id="cashBox" style="display:none">
        <label class="small" style="width:100px">Paga con</label>
        <input id="cashGiven" type="number" min="0" value="0" style="max-width:160px">
        <span class="badge">Vuelto: $<span id="cashChange">0</span></span>
      </div>

      <div class="actions" style="justify-content:flex-end">
        <button id="finishBtn">Cobrar / Ticket</button>
        <button id="reprintBtn" title="Reimprimir √∫ltimo ticket">Reimprimir</button>
        <button id="clearBtn">Vaciar</button>
      </div>
    </div>

    <div class="total">
      <span id="itemsCount">0 √≠tems</span>
      <span>
        <span class="badge">Neto: $<span id="sumNet">0</span></span>
        <span class="badge">IVA: $<span id="sumTax">0</span></span>
        <span class="badge">Desc. gen.: $<span id="sumGlobalDisc">0</span></span>
        <span class="badge">Total: $<span id="grandTotal">0</span></span>
      </span>
    </div>

  </section>
</main>

<script>
/* ====== CONFIG ====== */
const API_URL = "https://script.google.com/macros/s/AKfycbz700j5bneZF5-RiJm8lA7Af1vvXcnkwQnrjYbch3hqEuhMUwtgaBpvIztLwR72bakk/exec";

/* ====== Helpers & API ====== */
const IVA=0.19, fmt=n=>new Intl.NumberFormat('es-CL').format(Math.round(n||0));
async function apiGet(action){ const r=await fetch(`${API_URL}?action=${encodeURIComponent(action)}`); return r.json(); }
async function apiPost(action,payload){
  const r=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify({action,...payload})});
  return r.json();
}

/* ====== Cloud ====== */
async function cloudGetProducts(){
  const r = await apiGet('LIST_PRODUCTS'); if(!r.ok) throw new Error('LIST_PRODUCTS');
  return r.data.map(p=>({code:String(p.code),title:String(p.title),priceNet:Number(p.priceNet||0),stock:Number(p.stock||0)}));
}
async function cloudRegisterSale(sale){
  const r = await apiPost('REGISTER_SALE', { sale }); if(!r.ok) throw new Error('REGISTER_SALE');
  return r.data; // { saleId }
}

/* ====== POS state ====== */
// cart: Map code -> {code,title,priceNet,qty,discType,discValue}
const cart=new Map();
let lastTicketHTML='';

function focusScan(){ const el=document.getElementById('scanInput'); el.focus(); el.select?.(); }

function addOrInc(code, product){
  const negative = document.getElementById('returnMode').checked;
  const delta = negative ? -1 : 1;
  const it = cart.get(code) || {code:product.code,title:product.title,priceNet:product.priceNet,qty:0,discType:'none',discValue:0};
  it.qty += delta;
  if (it.qty === 0) cart.delete(code); else cart.set(code,it);
  renderCart();
}

async function addByCode(code){
  const products=await cloudGetProducts();
  const p=products.find(r=>r.code===code);
  if(!p){ alert('C√≥digo no encontrado'); return; }
  if((p.stock||0)<=0 && !document.getElementById('returnMode').checked){
    if(!confirm('Stock en 0. ¬øAgregar de todos modos?')) return;
  }
  addOrInc(code, p);
}

async function addByTitle(q){
  const products=await cloudGetProducts();
  const f=q.toLowerCase();
  const p=products.find(r=>(r.title||'').toLowerCase().includes(f));
  if(!p){ alert('No encontrado'); return; }
  addOrInc(p.code, p);
}

/* ====== Totals ====== */
function computeLine(it){
  const unit = Number(it.priceNet||0);
  const qty  = Number(it.qty||0);
  let unitAfter = unit;
  if(it.discType==='percent'){
    unitAfter = unit * (1 - (Number(it.discValue||0)/100));
  }else if(it.discType==='amount'){
    unitAfter = Math.max(0, unit - Number(it.discValue||0));
  }
  const lineNet = unitAfter * qty;
  const lineTax = lineNet * IVA;
  const lineTot = lineNet + lineTax;
  return {unitAfter,lineNet,lineTax,lineTot};
}

function computeTotals(){
  let net=0,tax=0,total=0;
  for(const it of cart.values()){
    const c = computeLine(it);
    net += c.lineNet; tax += c.lineTax; total += c.lineTot;
  }
  // Global discount (sobre neto ya con descuentos de l√≠nea)
  const type = document.getElementById('globalDiscType').value;
  const val  = Number(document.getElementById('globalDiscValue').value||0);
  let globalDiscNet = 0;
  if(type==='percent') globalDiscNet = net * (val/100);
  else if(type==='amount') globalDiscNet = Math.min(net, val);

  net = net - globalDiscNet;
  tax = net * IVA;
  total = net + tax;

  return {net,tax,total,globalDiscNet};
}

/* ====== Render ====== */
function renderCart(){
  const tb=document.querySelector('#cartTable tbody'); tb.innerHTML='';
  for(const it of cart.values()){
    const c=computeLine(it);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${it.code}</td>
      <td>${it.title}</td>
      <td class="inline" style="gap:6px">
        <button data-a="dec" data-code="${it.code}" style="width:auto;padding:6px 10px">‚àí</button>
        <span>${it.qty}</span>
        <button data-a="inc" data-code="${it.code}" style="width:auto;padding:6px 10px">+</button>
      </td>
      <td>$${fmt(it.priceNet)}</td>
      <td>
        <select data-a="discType" data-code="${it.code}">
          <option value="none" ${it.discType==='none'?'selected':''}>Ninguno</option>
          <option value="percent" ${it.discType==='percent'?'selected':''}>%</option>
          <option value="amount" ${it.discType==='amount'?'selected':''}>$</option>
        </select>
      </td>
      <td><input type="number" min="0" value="${it.discValue||0}" data-a="discValue" data-code="${it.code}" /></td>
      <td>$${fmt(c.lineNet)}</td>
      <td>$${fmt(c.lineTax)}</td>
      <td>$${fmt(c.lineTot)}</td>
      <td><button data-a="del" data-code="${it.code}">Quitar</button></td>`;
    tb.appendChild(tr);
  }
  // Wire buttons & inputs
  tb.querySelectorAll('button').forEach(b=>{
    const code=b.dataset.code, a=b.dataset.a;
    b.onclick=()=>{
      const it=cart.get(code); if(!it) return;
      if(a==='inc') it.qty++;
      if(a==='dec') it.qty=(it.qty>0?it.qty-1:it.qty-1); // permite negativas en modo cambio
      if(a==='del') cart.delete(code);
      renderCart();
    };
  });
  tb.querySelectorAll('select, input').forEach(el=>{
    el.oninput=()=>{
      const code=el.dataset.code; const it=cart.get(code); if(!it) return;
      if(el.dataset.a==='discType') it.discType = el.value;
      if(el.dataset.a==='discValue') it.discValue = Number(el.value||0);
      renderCart();
    };
  });

  // Totales
  const t=computeTotals();
  document.getElementById('sumNet').textContent=fmt(t.net);
  document.getElementById('sumTax').textContent=fmt(t.tax);
  document.getElementById('grandTotal').textContent=fmt(t.total);
  document.getElementById('sumGlobalDisc').textContent=fmt(t.globalDiscNet);

  // Items count
  const count = Array.from(cart.values()).reduce((a,it)=>a+Math.abs(it.qty),0);
  document.getElementById('itemsCount').textContent=`${count} √≠tems`;

  // Cash change
  updateChange();
}

/* ====== Payment & change ====== */
function updateChange(){
  const method=document.getElementById('payMethod').value;
  const cashBox=document.getElementById('cashBox');
  cashBox.style.display = (method==='efectivo') ? 'flex' : 'none';
  if(method!=='efectivo'){ document.getElementById('cashGiven').value=0; document.getElementById('cashChange').textContent='0'; return; }
  const total = computeTotals().total;
  const given = Number(document.getElementById('cashGiven').value||0);
  const change = Math.max(0, given - total);
  document.getElementById('cashChange').textContent = fmt(change);
}

/* ====== Ticket ====== */
function buildTicketHTML(saleId, items, sums, method, isReturn){
  const lines = items.map(it=>{
    const d = it.discType==='percent' ? ` (-${it.discValue}% )` :
              it.discType==='amount'  ? ` (-$${fmt(it.discValue)} c/u)` : '';
    const unitAfter = computeLine(it).unitAfter;
    return `${it.qty} x ${it.title} ‚Äî $${fmt(unitAfter)}${d}`;
  }).join('<br>');

  const sub = `Neto: $${fmt(sums.net)} ‚Äî IVA (19%): $${fmt(sums.tax)}`;
  const discGen = sums.globalDiscNet>0 ? `<div>Descuento general: $${fmt(sums.globalDiscNet)}</div>` : '';
  const title = isReturn ? 'Ticket de Cambio' : 'Ticket de Venta';

  return `<!doctype html><html><head><meta charset='utf-8'><title>${title}</title>
    <style>body{font-family:monospace;padding:8px}h1{font-size:16px;margin:0 0 6px}
    hr{border:none;border-top:1px dashed #888;margin:6px 0}</style></head>
    <body>
      <h1>Librer√≠a de Fuego</h1>
      <div>${title} #${saleId} ‚Äî ${new Date().toLocaleString('es-CL')}</div>
      <hr>${lines}<hr>
      <div>${sub}</div>${discGen}
      <div><b>Total: $${fmt(sums.total)}</b></div>
      <div>Pago: ${method}</div>
      <hr><small>Gracias por tu compra</small>
    </body></html>`;
}

/* ====== Events ====== */
// Agregar por c√≥digo: bot√≥n
document.getElementById('scanBtn').onclick=async ()=>{
  const c=document.getElementById('scanInput').value.trim(); if(!c) return;
  await addByCode(c); document.getElementById('scanInput').value=''; focusScan();
};
// Agregar por c√≥digo: ENTER del teclado/lector ‚Üí agrega autom√°tico
document.getElementById('scanInput').addEventListener('keydown', async (e)=>{
  if(e.key==='Enter'){
    e.preventDefault();
    const c=e.target.value.trim(); if(!c) return;
    await addByCode(c); e.target.value=''; focusScan();
  }
});
// Algunos lectores pegan un salto de l√≠nea: detecta y agrega
document.getElementById('scanInput').addEventListener('input', async (e)=>{
  const v=e.target.value;
  if(v.includes('\n')){
    const c=v.replace(/\s+/g,'').trim();
    if(c){ await addByCode(c); }
    e.target.value=''; focusScan();
  }
});

document.getElementById('pickBtn').onclick=async ()=>{
  const t=document.getElementById('searchTitle').value.trim(); if(!t) return;
  await addByTitle(t); document.getElementById('searchTitle').value='';
};

['globalDiscType','globalDiscValue','payMethod','cashGiven'].forEach(id=>{
  document.getElementById(id).addEventListener('input',()=>{ if(id==='payMethod') updateChange(); renderCart(); });
});

document.getElementById('clearBtn').onclick=()=>{ cart.clear(); renderCart(); focusScan(); };

document.getElementById('finishBtn').onclick=async ()=>{
  if(cart.size===0){ alert('Carrito vac√≠o'); focusScan(); return; }
  const method=document.getElementById('payMethod').value;
  const sums = computeTotals();

  // Construir items para la venta (priceNet original, descuentos expl√≠citos)
  const items=[];
  for(const it of cart.values()){
    items.push({
      code: it.code, title: it.title, qty: it.qty,
      priceNet: it.priceNet,
      discType: it.discType, discValue: Number(it.discValue||0)
    });
  }

  // Guardar en la nube
  try{
    const resp = await cloudRegisterSale({ items, method, totalNet: sums.net, totalTax: sums.tax, total: sums.total });
    const saleId = resp.saleId;
    const isReturn = document.getElementById('returnMode').checked;
    const html = buildTicketHTML(saleId, items, sums, method, isReturn);
    lastTicketHTML = html;
    const w=window.open('','_blank','width=430,height=640'); w.document.write(html); w.document.close(); w.print();

    cart.clear(); renderCart(); focusScan();
    alert(isReturn ? 'Cambio registrado y stock repuesto ‚úÖ' : 'Venta registrada en la nube ‚úÖ');
  }catch(err){
    alert('Error registrando: ' + err.message);
  }
};

document.getElementById('reprintBtn').onclick=()=>{
  if(!lastTicketHTML){ alert('A√∫n no hay ticket para reimprimir'); return; }
  const w=window.open('','_blank','width=430,height=640'); w.document.write(lastTicketHTML); w.document.close(); w.print();
};

// Inicial
renderCart(); focusScan();
</script>
</body>
</html>
