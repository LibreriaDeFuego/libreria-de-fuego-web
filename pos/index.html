<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Caja (POS) ‚Äî Librer√≠a de Fuego ‚Äî Papel & Tinta</title>

<style>
:root{
  --bg:#FFF9EB; --ink:#1F1A17; --sepia:#6A3B2E; --terra:#FF6B4A;
  --green:#00B37E; --line:#FFE3C7; --muted:#7A6A60; --card:#FFFFFF;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
h1,h2,h3{margin:0 0 10px}
a{color:var(--terra);text-decoration:none}
button{cursor:pointer;font-weight:600;border-radius:12px;border:1px solid var(--line);background:#fff;color:var(--ink);padding:10px 12px}
button.primary{background:var(--terra);color:#fff;border-color:#C45F2F}
button.green{background:var(--green);color:#fff;border-color:#276946}
button.ghost{background:#fff;color:var(--sepia)}
button:disabled{opacity:.6;cursor:not-allowed}

.container{max-width:1200px;margin:0 auto;padding:16px}
header .brand{font-size:20px;font-weight:800;letter-spacing:.2px}

/* 75% / 25% escritorio; 100% m√≥vil */
.grid{display:grid;gap:14px;grid-template-columns:3fr 1fr;align-items:start}
@media (max-width:980px){ .grid{grid-template-columns:1fr} }

.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 6px 20px rgba(0,0,0,.04)}
.card h2{font-size:16px}

.omniWrap{position:relative}
.omniWrap input{width:100%;padding:14px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;color:#000;font-size:16px}
.suggestBox{position:absolute;left:0;right:0;top:56px;background:#fff;border:1px solid var(--line);border-radius:12px;max-height:360px;overflow:auto;z-index:9999;box-shadow:0 10px 24px rgba(0,0,0,.08)}
.suggestItem{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px;border-radius:10px;cursor:pointer}
.suggestItem:hover,.suggestItem.active{background:#FFF1D7}
.left{display:flex;align-items:center;gap:10px;min-width:0}
.cover{width:42px;height:60px;border-radius:10px;object-fit:cover;background:#EEE;border:1px solid #E8E1D9}
.no-cover{width:42px;height:60px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:#EEE;color:#777;font-weight:700}
.meta{display:flex;flex-direction:column;gap:2px;min-width:0}
.meta .t{font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.meta .a{font-size:12px;color:#737373;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.meta .p{font-size:12px;color:var(--sepia)}
.stock{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid var(--line)}
.stock.good{background:#EFF7F1;border-color:#D5E9DB;color:#246744}
.stock.none{background:#FCEDEA;border-color:#F2C7BB;color:#9A3D1D}

.small{font-size:12px;color:var(--muted)}
.line{display:flex;align-items:center;gap:8px}

table{width:100%;border-collapse:separate;border-spacing:0 8px}
th,td{text-align:left;font-size:12px;padding:10px;border-bottom:1px dashed var(--line);vertical-align:middle}
td input[type="number"], td input[data-a="discValue"]{padding:8px;border-radius:10px;border:1px solid var(--line);background:#fff;color:#000;width:100%}

.seg{display:inline-flex;border:1px solid var(--line);border-radius:10px;overflow:hidden}
.seg button{padding:8px 10px;background:#fff;border:0;color:#000}
.seg button + button{border-left:1px solid var(--line)}
.seg button.active{background:#FFE3BD}

.row-selected{background:#FFF4EE}

.stickyBar{position:fixed;left:0;right:0;bottom:0;z-index:9000;display:flex;align-items:center;justify-content:space-between;gap:8px;background:rgba(250,247,242,.9);backdrop-filter:saturate(1.1) blur(6px);border-top:1px solid var(--line);padding:10px 12px}

#cartTable .seg[data-line]{display:flex;flex:0 0 120px;max-width:120px}
#cartTable .seg[data-line] button{flex:1 1 0;min-width:0;height:34px;padding:0;line-height:1}
#cartTable td input[data-a="discValue"]{max-width:110px}
#cartTable tbody td .line button.ghost{height:34px;display:inline-flex;align-items:center;justify-content:center;border-radius:999px}

/* Sidebar */
.sideDock{position:fixed;left:0;top:0;bottom:0;width:56px;background:#FFFFFF;border-right:1px solid var(--line);z-index:9100;padding:10px 6px;display:flex;flex-direction:column;gap:8px;transition:width .18s ease;box-shadow:0 10px 24px rgba(0,0,0,.04)}
.sideDock:hover{width:200px}
.sideDock .dockItem{display:flex;align-items:center;gap:12px;padding:10px;border-radius:12px;color:var(--ink);border:1px solid transparent;text-decoration:none;white-space:nowrap}
.sideDock .dockItem:hover{background:#FFF4EE;border-color:#EEC8B3}
.sideDock .ico{font-size:18px;width:24px;text-align:center}
.sideDock .lbl{opacity:0;transition:opacity .16s}
.sideDock:hover .lbl{opacity:1}
.container{margin-left:72px}
.navLinks{display:none !important}

/* COBRO (azul oscuro) */
.cobroCard{background:#1c2353!important;color:#fff!important;border:none!important;box-shadow:0 6px 20px rgba(0,0,0,.3)}
.cobroCard .small,.cobroCard label,.cobroCard h2{color:#fff!important}
.cobroCard .payBtn{width:100%;border-color:transparent}
.cobroCard .payBtn.active{background:#ff751f;color:#fff;border-color:#ff751f}

/* ======= SWITCH DE DESCUENTO (sin c√≠rculo en %) ======= */
#genSeg{display:inline-flex}
.seg.pill{
  display:flex;align-items:center;gap:10px;
  background:#26306a;border:0;padding:6px 8px;border-radius:999px;
}
/* $ a la izquierda, se ‚Äúpega‚Äù al √≥valo cuando est√° activo */
.seg.pill .pill-icon{
  display:inline-flex;align-items:center;justify-content:center;
  height:34px; min-width:34px; padding:0 10px;
  border-radius:999px;border:0; background:transparent;
  color:#cfd6ff; font-weight:900;
  transition:background .2s,color .2s;
}
/* Contenedor del input + % */
.seg.pill .pill-input{position:relative;display:flex;align-items:center}
/* Input siempre √≥valo blanco */
.seg.pill .pill-input input{
  width:120px;height:34px;border:0;background:#fff;color:#000;
  font-weight:800;text-align:center;border-radius:999px;outline:none;
  padding-right:28px;
}
/* % sin c√≠rculo (solo texto pegado al borde derecho) */
.seg.pill .pill-input .pill-percent{
  position:absolute;right:10px;top:50%;transform:translateY(-50%);
  border:0;background:transparent;padding:0;margin:0;
  width:auto;height:auto;border-radius:0;
  color:#cfd6ff;font-weight:900;line-height:1;cursor:pointer;
  transition:color .2s;
}
/* Estados visuales de switch */
.seg.pill.mode-percent .pill-icon{ background:transparent; color:#cfd6ff; }
.seg.pill.mode-percent .pill-input input{ background:#fff; }
.seg.pill.mode-percent .pill-input .pill-percent{ color:#000; }  /* % activo */
.seg.pill.mode-amount .pill-icon{ background:#fff; color:#000; } /* $ activo */
.seg.pill.mode-amount .pill-input input{ background:#fff; }
.seg.pill.mode-amount .pill-input .pill-percent{ color:#cfd6ff; } /* % apagado */

/* Total azul centrado con descuento abajo-derecha */
.totalChip{
  position:relative;background:#537BFF;color:#fff;
  padding:22px 24px 30px;border-radius:22px;min-width:260px;
  box-shadow:0 10px 22px rgba(0,0,0,.18);text-align:center;
}
.totalChip .t1{position:absolute;top:10px;left:16px;font-size:14px;opacity:.92;margin:0;text-align:left}
.totalChip .t2{font-size:40px;font-weight:900;line-height:1.05;margin:10px 0 16px}
.totalChip .t3{position:absolute;right:16px;bottom:12px;font-size:16px;opacity:.95;font-weight:600}

/* Switch Pago dividido */
.toggle-switch{position:relative;display:inline-block;width:48px;height:24px}
.toggle-switch input{opacity:0;width:0;height:0}
.slider{position:absolute;inset:0;background:#ccc;border-radius:34px;transition:.3s;cursor:pointer}
.slider:before{content:"";position:absolute;left:3px;bottom:3px;width:18px;height:18px;background:#fff;border-radius:50%;transition:.3s}
.toggle-switch input:checked + .slider{background:#537BFF}
.toggle-switch input:checked + .slider:before{transform:translateX(24px)}

/* Barra split */
#splitBar{height:6px;width:100%;border-radius:10px;background:linear-gradient(to right,#537BFF 100%,#FF70D7 0%)}
</style>
</head>
<body>

<aside class="sideDock" aria-label="Navegaci√≥n principal">
  <a href="inventario.html" class="dockItem" title="Inventario"><span class="ico">üìö</span><span class="lbl">Inventario</span></a>
  <a href="reportes.html" class="dockItem" title="Reportes"><span class="ico">üìä</span><span class="lbl">Reportes</span></a>
  <a href="bodega.html" class="dockItem" title="Bodega"><span class="ico">üè∑Ô∏è</span><span class="lbl">Bodega</span></a>
</aside>

<div class="container">
  <header class="topbar" style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
    <div class="leftBar">
      <div class="brand">üßæ Caja (POS) ‚Äî Librer√≠a de Fuego</div>
      <nav class="navLinks">
        <a href="inventario.html">üìö Inventario</a>
        <a href="reportes.html">üìä Reportes</a>
        <a href="bodega.html">üè∑Ô∏è Bodega</a>
      </nav>
    </div>
    <div class="small">Ayuda <button id="helpOpen" class="ghost" title="Atajos y ayuda">?</button></div>
  </header>

  <section class="grid">
    <!-- IZQUIERDA: Carro -->
    <div class="card">
      <h2>Detalle de venta</h2>

      <div class="omniWrap" style="margin-top:8px">
        <input id="omniInput" placeholder="Escanea o escribe t√≠tulo, autor o c√≥digo" autocomplete="off" aria-autocomplete="list" aria-controls="searchResults" aria-expanded="false" aria-haspopup="listbox">
        <div id="searchResults" class="suggestBox" role="listbox" hidden></div>
      </div>

      <div class="line small" style="margin-top:8px">
        <label class="line" title="Si activas Modo cambio, las cantidades se agregan negativas (devuelve stock)">
          <input id="returnMode" type="checkbox" style="width:auto;margin-right:6px"> Modo cambio / devoluci√≥n
        </label>
        <span>‚Ä¢ Doble clic fila: +1 ‚Ä¢ Alt+clic: ‚àí1 ‚Ä¢ Supr: quitar ‚Ä¢ <kbd>/</kbd> enfoca b√∫squeda</span>
      </div>

      <hr class="sep">

      <table id="cartTable" aria-label="Carrito de venta">
        <thead>
          <tr>
            <th style="width:110px">C√≥digo</th>
            <th>T√≠tulo</th>
            <th style="width:140px">Cantidad</th>
            <th style="width:120px">PVP</th>
            <th style="width:300px">Descuento</th>
            <th style="width:120px">Total</th>
            <th style="width:70px"></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="line" style="margin-top:8px;justify-content:flex-end;flex-wrap:wrap;gap:10px">
        <button id="retryOutboxBtn" class="ghost" style="display:none" title="Reenviar ventas pendientes">Reintentar pendientes</button>
        <button id="clearBtn" class="ghost">Vaciar</button>
      </div>

      <div class="card" id="bodegaPanel" style="margin-top:12px">
        <h2>üè∑Ô∏è Bodega (reposiciones sugeridas)</h2>
        <p class="small">Cuando vendas, aqu√≠ ver√°s lo que conviene traer desde bodega.</p>
        <div id="bodegaList" class="bodegaList">Sin sugerencias por ahora</div>
        <div class="line" style="justify-content:flex-end;margin-top:8px">
          <a class="ghost" href="bodega.html" title="Abrir p√°gina de Bodega">Abrir p√°gina de Bodega ‚Üí</a>
        </div>
      </div>
    </div>

    <!-- DERECHA: COBRO -->
    <div class="card cobroCard">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <h2>COBRO</h2>
        <button id="menuCobro" style="background:none;border:none;font-size:20px;cursor:pointer;color:#fff">‚ãÆ</button>
      </div>

      <!-- Descuento -->
      <div class="line" style="margin-top:10px;flex-wrap:wrap">
        <label class="small" style="width:100%">Descuento</label>
        <div class="seg pill mode-percent" id="genSeg">
          <button type="button" class="pill-icon" data-v="amount" aria-label="Descuento en pesos">$</button>
          <div class="pill-input">
            <input id="globalDiscValue" type="text" inputmode="numeric" value="0" data-format="money" aria-label="Valor de descuento">
            <button type="button" class="pill-percent" data-v="percent" aria-label="Descuento en porcentaje">%</button>
          </div>
        </div>
        <input id="globalDiscType" type="hidden" value="percent">
      </div>

      <!-- Total -->
      <div class="line" style="margin-top:8px;justify-content:center">
        <div class="totalChip">
          <div class="t1">Total</div>
          <div class="t2">$<span id="grandTotal">0</span></div>
          <div class="t3">Descuento: -$<span id="grandDiscount">0</span></div>
        </div>
      </div>

      <hr class="sep">

      <!-- M√©todos de pago -->
      <label class="small">M√©todo de pago</label>
      <div class="line" style="flex-direction:column;align-items:stretch;gap:8px;margin-top:6px">
        <button class="payBtn" data-method="debito">D√âBITO</button>
        <button class="payBtn" data-method="credito">CR√âDITO</button>
        <button class="payBtn" data-method="transferencia">TRANSFERENCIA</button>
        <button class="payBtn" data-method="efectivo">EFECTIVO</button>
      </div>

      <!-- Efectivo -->
      <div id="efectivoBox" style="display:none;margin-top:10px">
        <label class="small">PAGA CON</label>
        <input id="pagaCon" type="text" inputmode="numeric" value="0" data-format="money" style="max-width:160px">
        <label class="small" style="margin-top:6px">VUELTO</label>
        <div style="font-size:20px;font-weight:700" id="vueltoDisplay">$0</div>
      </div>

      <hr class="sep">

      <!-- Pago dividido -->
      <div class="line" style="align-items:center;justify-content:space-between">
        <label class="small">Pago dividido</label>
        <label class="toggle-switch">
          <input type="checkbox" id="splitToggle">
          <span class="slider"></span>
        </label>
      </div>
      <div id="splitBar"></div>

      <hr class="sep">

      <button id="saveCartBtn" class="ghost" style="width:100%">Guardar carro</button>
    </div>
  </section>
</div>

<div class="stickyBar" id="stickyBar" aria-live="polite">
  <div><b>Total:</b> $<span id="grandTotalSticky">0</span> ‚Äî <span id="itemsCountSticky">0 √≠tems</span></div>
  <div class="line">
    <button id="finishBtnSticky" class="green">Cobrar / Ticket</button>
    <button id="helpOpen2" class="ghost" title="Ver atajos y ayuda">?</button>
  </div>
</div>

<div id="toasts" aria-live="polite" aria-atomic="true"></div>

<div class="modalScrim" id="confirmScrim" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
  <div class="modal">
    <h3 id="confirmTitle">Confirmar</h3>
    <p id="confirmMsg">¬øSeguro?</p>
    <div class="row">
      <button id="confirmCancel" class="ghost">Cancelar</button>
      <button id="confirmOk" class="primary">Aceptar</button>
    </div>
  </div>
</div>

<div class="modalScrim" id="helpScrim" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
  <div class="modal">
    <h3 id="helpTitle">Ayuda r√°pida</h3>
    <p><kbd>Enter</kbd> agrega el primer resultado ‚Ä¢ <kbd>Esc</kbd> cierra sugerencias ‚Ä¢ Doble clic fila: +1 ‚Ä¢ <kbd>Alt</kbd>+clic: ‚àí1 ‚Ä¢ <kbd>Supr</kbd>: quitar fila ‚Ä¢ <kbd>/</kbd> enfoca la b√∫squeda.</p>
    <div class="row"><button id="helpClose" class="ghost">Cerrar</button></div>
  </div>
</div>

<script>
/* ========= API CONFIG ========= */
const API_URL="https://script.google.com/macros/s/AKfycbz700j5bneZF5-RiJm8lA7Af1vvXcnkwQnrjYbch3hqEuhMUwtgaBpvIztLwR72bakk/exec";
const IVA=0.19;

/* ===== Helpers dinero ===== */
const fmt=n=>new Intl.NumberFormat('es-CL').format(Math.round(n||0));
const digitsOnly=v=>(v||'').toString().replace(/\D/g,'');

function readMoney(elOrId){const el=typeof elOrId==='string'?document.getElementById(elOrId):elOrId;if(!el) return 0;const d=digitsOnly(el.value);return d?Number(d):0;}
function setMoneyValue(elOrId,value){const el=typeof elOrId==='string'?document.getElementById(elOrId):elOrId;if(!el)return;const n=Math.max(0,Math.round(Number(value)||0));el.value=fmt(n);}
function formatMoneyInput(el){if(!el)return;const d=digitsOnly(el.value);el.value=d?fmt(Number(d)):'';}
function attachMoneyFormatters(root=document){
  (root instanceof Element?root:document).querySelectorAll('input[data-format="money"]').forEach(el=>{
    if(el.dataset.moneyBound==='1')return;
    formatMoneyInput(el);
    if(el.value===''){el.value='0';}
    el.addEventListener('focus',()=>{ if(readMoney(el)===0){ el.value=''; } setTimeout(()=>{try{el.setSelectionRange(el.value.length,el.value.length);}catch{}},0);});
    el.addEventListener('blur',()=>{ formatMoneyInput(el); if(el.value===''){el.value='0';} });
    el.addEventListener('input',()=>{ const d=digitsOnly(el.value); el.value=d?fmt(Number(d)):''; setTimeout(()=>{try{el.setSelectionRange(el.value.length,el.value.length);}catch{}},0); });
    el.dataset.moneyBound='1';
  });
}

/* ===== Beep + Toast ===== */
let audioCtx=null;function ensureAudio(){if(!audioCtx){try{audioCtx=new(window.AudioContext||window.webkitAudioContext)();}catch{}}}
function beepError(){ensureAudio();if(!audioCtx)return;const o=audioCtx.createOscillator(),g=audioCtx.createGain();const now=audioCtx.currentTime;o.frequency.setValueAtTime(280,now);g.gain.setValueAtTime(0.0001,now);g.gain.exponentialRampToValueAtTime(0.25,now+0.01);g.gain.exponentialRampToValueAtTime(0.0001,now+0.18);o.connect(g);g.connect(audioCtx.destination);o.start(now);o.stop(now+0.2);}
function toast(msg,kind='ok',timeout=2400){const box=document.getElementById('toasts');const el=document.createElement('div');el.className='toast '+(kind==='err'?'err':'');el.textContent=msg;box.appendChild(el);setTimeout(()=>{el.style.opacity='0';el.style.transform='translateY(6px)';},timeout-180);setTimeout(()=>{box.removeChild(el);},timeout);}

/* ===== API base ===== */
async function apiGet(url){ const r=await fetch(url,{mode:'cors',credentials:'omit'}); return r.json(); }

/* ===== Productos (cache + carga robusta) ===== */
const CACHE_TTL_MS=10*60*1000;
let productCache=null;
(function(){ try{ const raw=localStorage.getItem('pos_products_cache'); if(raw){ const {ts,arr}=JSON.parse(raw); productCache={ts,arr}; } }catch{} })();

async function cloudGetProducts(){
  const tries = [
    `${API_URL}?action=LIST_PRODUCTS`,
    `${API_URL}?action=GET_PRODUCTS`,
    `${API_URL}?action=PRODUCTS`,
    `${API_URL}?action=ALL_PRODUCTS`,
    `${API_URL}`
  ];
  let data=null, lastErr=null;
  for(const url of tries){
    try{
      const r = await apiGet(url);
      if(Array.isArray(r)) { data=r; break; }
      if(r?.ok && Array.isArray(r.data)) { data=r.data; break; }
      if(Array.isArray(r?.items)) { data=r.items; break; }
    }catch(e){ lastErr=e; }
  }
  if(!data) throw lastErr||new Error('No se pudo listar productos');
  return data.map(p=>({
    code : String(p.code ?? p.Codigo ?? p.codigo ?? p.barcode ?? p.ean ?? ''),
    title: String(p.title ?? p.Titulo ?? p.titulo ?? 'Sin t√≠tulo'),
    author: String(p.author ?? p.autor ?? p.autores ?? ''),
    cover: String(p.cover ?? p.image ?? p.coverUrl ?? p.portada ?? p.thumbnail ?? ''),
    pricePVP: Number(p.pricePVP ?? ((Number(p.priceNet||p.neto||p.precio)||0)*(1+IVA))),
    stock: Number(p.stock ?? p.Stock ?? 0)
  })).filter(p=>p.code);
}
async function loadProductsCached(){
  try{
    if(productCache && (Date.now()-productCache.ts)<CACHE_TTL_MS) return productCache.arr;
    const arr = await cloudGetProducts();
    productCache = {ts:Date.now(), arr};
    try{ localStorage.setItem('pos_products_cache', JSON.stringify(productCache)); }catch{}
    return arr;
  }catch(e){
    toast('No se pudo cargar productos de la API.','err'); beepError(); throw e;
  }
}

/* ===== Estado POS ===== */
const cart=new Map();
let selectedCode=null, lastTicketHTML='', lastScan={code:'',at:0};

/* ===== Totales ===== */
function computeLine(it){
  const unit = Number(it.pricePVP||0);
  const qty  = Number(it.qty||0);
  let unitAfter = unit;
  if(it.discType==='percent'){ unitAfter = unit * (1 - (Number(it.discValue||0)/100)); }
  else if(it.discType==='amount'){ unitAfter = Math.max(0, unit - Number(it.discValue||0)); }
  const base = unit * qty;
  const descLine = base - unitAfter * qty;
  const total = unitAfter * qty;
  return {unit, unitAfter, base, descLine, total};
}
function computeTotals(){
  let subtotal=0, descLineas=0;
  for(const it of cart.values()){ const c=computeLine(it); subtotal+=c.total; descLineas+=c.descLine; }
  const type=document.getElementById('globalDiscType').value;
  const val=readMoney('globalDiscValue');
  let descGeneral=0;
  if(type==='percent') descGeneral = subtotal * (val/100);
  else if(type==='amount') descGeneral = Math.min(subtotal, val);
  const descuentosTotales = Math.max(0, descLineas + descGeneral);
  const totalCompra = Math.max(0, subtotal - descGeneral);
  return {subtotal, descLineas, descGeneral, descuentosTotales, totalCompra};
}
function updateTotalsUI(){
  const t=computeTotals();
  document.getElementById('grandTotal').textContent=fmt(t.totalCompra);
  document.getElementById('grandTotalSticky').textContent=fmt(t.totalCompra);
  document.getElementById('grandDiscount').textContent=fmt(t.descuentosTotales);
  const count=[...cart.values()].reduce((a,it)=>a+Math.abs(it.qty),0);
  document.getElementById('itemsCountSticky').textContent=`${fmt(count)} √≠tems`;
  updateVuelto();
  saveUI();
}

/* ===== Render del Carro ===== */
function renderCart(){
  const tb=document.querySelector('#cartTable tbody'); tb.innerHTML='';
  for(const it of cart.values()){
    const c=computeLine(it);
    const tr=document.createElement('tr');
    tr.title='Doble clic: +1 ‚Ä¢ Alt+clic: ‚àí1 ‚Ä¢ Supr: quitar';
    tr.dataset.code = it.code;
    tr.innerHTML=`
      <td>${it.code}</td>
      <td>${it.title}</td>
      <td class="line" style="gap:6px">
        <button data-a="dec" data-code="${it.code}" class="ghost" style="padding:6px 10px">‚àí</button>
        <span>${it.qty}</span>
        <button data-a="inc" data-code="${it.code}" class="ghost" style="padding:6px 10px">+</button>
      </td>
      <td>$${fmt(it.pricePVP)}</td>
      <td>
        <div class="line" style="gap:6px;justify-content:flex-end">
          <div class="seg" data-line="${it.code}">
            <button type="button" data-a="discType" data-v="percent" class="${it.discType==='percent'?'active':''}">%</button>
            <button type="button" data-a="discType" data-v="amount"  class="${it.discType==='amount'?'active':''}">$</button>
            <button type="button" data-a="discNone"  class="${it.discType==='none'?'active':''}">sin</button>
          </div>
          <input type="text" inputmode="numeric" value="${it.discValue||0}" data-a="discValue" data-code="${it.code}" data-format="money" style="max-width:110px" />
        </div>
      </td>
      <td class="lineTotal">$${fmt(c.total)}</td>
      <td><button data-a="del" data-code="${it.code}" class="ghost">Quitar</button></td>`;
    attachMoneyFormatters(tr);
    tb.appendChild(tr);

    tr.onclick=(ev)=>{ document.querySelectorAll('#cartTable tbody tr').forEach(r=>r.classList.remove('row-selected')); tr.classList.add('row-selected'); selectedCode=it.code; if(ev.altKey){ const item=cart.get(it.code); if(item){ item.qty--; if(item.qty===0) cart.delete(it.code); renderCart(); } } };
    tr.ondblclick=()=>{ const item=cart.get(it.code); if(item){ item.qty++; renderCart(); } };
  }
  // + / ‚àí / quitar
  tb.querySelectorAll('button').forEach(b=>{
    const code=b.dataset.code, a=b.dataset.a;
    b.onclick=()=>{
      const it=cart.get(code); if(!it) return;
      if(a==='inc') it.qty++;
      if(a==='dec') it.qty = (document.getElementById('returnMode').checked ? it.qty-1 : Math.max(0,it.qty-1));
      if(a==='del') cart.delete(code);
      if(it.qty===0) cart.delete(code);
      renderCart();
    };
  });
  // cambio de tipo de descuento por l√≠nea
  tb.querySelectorAll('.seg[data-line]').forEach(seg=>{
    seg.addEventListener('click',(e)=>{
      if(e.target.tagName!=='BUTTON')return;
      const code=seg.dataset.line;
      const it=cart.get(code); if(!it) return;
      const act=e.target.dataset.a;
      seg.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
      e.target.classList.add('active');
      if(act==='discType'){
        it.discType=e.target.dataset.v;
        if(!it.discValue) it.discValue=(it.discType==='percent'?1:100);
      }else if(act==='discNone'){
        it.discType='none'; it.discValue=0;
      }
      const row=seg.closest('tr');
      const c=computeLine(it);
      row.querySelector('.lineTotal').textContent='$'+fmt(c.total);
      updateTotalsUI();
    });
  });
  // valor descuento por l√≠nea (auto %/$)
  tb.querySelectorAll('input[data-a="discValue"]').forEach(el=>{
    el.oninput=()=>{
      const code=el.dataset.code;
      const it=cart.get(code); if(!it) return;
      const val=Math.max(0,readMoney(el));
      it.discValue=val;
      const seg=el.closest('tr')?.querySelector('.seg[data-line]');
      if(it.discType==='none' && val>0){
        it.discType=(val>100)?'amount':'percent';
        if(seg){ seg.querySelectorAll('button').forEach(b=>b.classList.remove('active')); seg.querySelector(`button[data-v="${it.discType==='amount'?'amount':'percent'}"]`)?.classList.add('active'); }
      }
      if(it.discType==='percent' && val>100){
        it.discType='amount';
        if(seg){ seg.querySelectorAll('button').forEach(b=>b.classList.remove('active')); seg.querySelector('button[data-v="amount"]')?.classList.add('active'); }
      }
      if(val===0){
        it.discType='none';
        if(seg){ seg.querySelectorAll('button').forEach(b=>b.classList.remove('active')); seg.querySelector('button[data-a="discNone"]')?.classList.add('active'); }
      }
      const row=el.closest('tr'); const c=computeLine(it);
      row.querySelector('.lineTotal').textContent='$'+fmt(c.total);
      updateTotalsUI();
    };
  });
  updateTotalsUI();
}

/* ===== Bodega mock ===== */
function updateBodegaPanel(){
  const box=document.getElementById('bodegaList'); if(!box) return;
  const items=[]; for(const it of cart.values()){ const qty=Math.max(0,it.qty); if(qty>0) items.push({code:it.code,title:it.title,qty}); }
  box.textContent = items.length ? items.map(x=>`${x.qty}√ó ${x.title} (${x.code})`).join(' ¬∑ ') : 'Sin sugerencias por ahora';
}

/* ===== M√©todos de pago ===== */
let currentMethod=null;
document.querySelectorAll('.payBtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.payBtn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    currentMethod = btn.dataset.method;
    document.getElementById('efectivoBox').style.display = (currentMethod==='efectivo') ? 'block' : 'none';
    updateVuelto();
  });
});
document.getElementById('pagaCon').addEventListener('input', updateVuelto);
function updateVuelto(){
  const total = computeTotals().totalCompra;
  const pago = readMoney('pagaCon');
  const vuelto = Math.max(0, pago - total);
  document.getElementById('vueltoDisplay').textContent = '$' + fmt(vuelto);
}

/* ===== Split ===== */
const splitToggle=document.getElementById('splitToggle');
splitToggle.addEventListener('change', ()=>{
  const bar=document.getElementById('splitBar');
  bar.style.background = splitToggle.checked
    ? 'linear-gradient(to right,#FF6B4A 50%,#8B5CF6 50%)'
    : 'linear-gradient(to right,#537BFF 100%,#FF70D7 0%)';
  saveUI();
});

/* ===== Guardar carro ===== */
document.getElementById('saveCartBtn').addEventListener('click', ()=>{
  if(cart.size===0){ toast('No hay productos en el carro','err'); beepError(); return; }
  try{ localStorage.setItem('saved_cart', JSON.stringify([...cart.values()])); toast('Carro guardado ‚úÖ'); }
  catch{ toast('Error al guardar','err'); beepError(); }
});

/* ===== Omnibox & b√∫squeda ===== */
const omni=document.getElementById('omniInput');
const results=document.getElementById('searchResults');
let suggIndex=-1;
function hideSuggestions(){ results.hidden=true; suggIndex=-1; omni.setAttribute('aria-expanded','false'); }
function showSuggestions(){ results.hidden=false; omni.setAttribute('aria-expanded','true'); }
const norm = s => (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();

function ean13valid(d){ if(!/^\d{13}$/.test(d)) return false; const a=d.split('').map(Number); const sum=a.slice(0,12).reduce((acc,n,i)=>acc+(i%2? n*3 : n),0); const check=(10-(sum%10))%10; return check===a[12]; }
function ean8valid(d){ if(!/^\d{8}$/.test(d)) return false; const a=d.split('').map(Number); const sum=a.slice(0,7).reduce((acc,n,i)=>acc+(i%2? n*3 : n),0); const check=(10-(sum%10))%10; return check===a[7]; }
function isCodeLike(s){
  const d = s.replace(/[^\d]/g,'');
  if(/^97[89]\d{10}$/.test(d) && ean13valid(d)) return {ok:true, code:d};
  if(/^\d{13}$/.test(d) && ean13valid(d)) return {ok:true, code:d};
  if(/^\d{12}$/.test(d)) return {ok:true, code:d};
  if(/^\d{8}$/.test(d) && ean8valid(d)) return {ok:true, code:d};
  return {ok:false};
}
function lev(a,b){ a=norm(a); b=norm(b); const m=a.length,n=b.length; if(m===0) return n; if(n===0) return m; const dp=new Array(n+1); for(let j=0;j<=n;j++) dp[j]=j; for(let i=1;i<=m;i++){ let prev=dp[0],cur; dp[0]=i; for(let j=1;j<=n;j++){ const cost=a[i-1]===b[j-1]?0:1; cur=Math.min(dp[j]+1, dp[j-1]+1, prev+cost); prev=dp[j]; dp[j]=cur; } } return dp[n]; }
function scoreParts(p,q){
  const T=norm(p.title), A=norm(p.author), Q=norm(q);
  let s=0;
  if(T.startsWith(Q)) s+=100; else if(T.includes(Q)) s+=70;
  if(A.startsWith(Q)) s+=60; else if(A.includes(Q)) s+=30;
  const dt=lev(T.slice(0,32),Q.slice(0,32)); if(dt<=2) s += (40 - dt*10);
  return s;
}
function stockBadge(p){
  const s=Number(p.stock||0);
  if(s<=0) return '<span class="stock none">Sin stock</span>';
  return `<span class="stock good">Stock: ${s}</span>`;
}
function renderSuggestions(list){
  results.innerHTML=''; if(list.length===0){ hideSuggestions(); return; }
  list.forEach((p,i)=>{
    const row=document.createElement('div'); row.className='suggestItem'+(i===suggIndex?' active':''); row.setAttribute('role','option');
    const left=document.createElement('div'); left.className='left';
    let coverEl; if(p.cover){ coverEl=document.createElement('img'); coverEl.className='cover'; coverEl.src=p.cover; coverEl.alt=p.title; }
    else{ coverEl=document.createElement('div'); coverEl.className='no-cover'; coverEl.textContent=(p.title||'?').slice(0,1).toUpperCase(); }
    const meta=document.createElement('div'); meta.className='meta';
    meta.innerHTML=`<div class="t">${p.title||'Sin t√≠tulo'}</div><div class="a">${p.author||'Autor desconocido'}</div><div class="p">$${fmt(p.pricePVP)}</div>`;
    left.appendChild(coverEl); left.appendChild(meta); row.appendChild(left);
    const right=document.createElement('div'); right.innerHTML=stockBadge(p); row.appendChild(right);
    row.onmousedown=(e)=>{ e.preventDefault(); addOrInc(p.code,p); hideSuggestions(); omni.value=''; focusOmni(); };
    results.appendChild(row);
  });
  showSuggestions();
}
let searchTimer=null;
async function doSearch(q){
  clearTimeout(searchTimer);
  searchTimer = setTimeout(async ()=>{
    const products = await loadProductsCached();
    const sorted = products.map(p=>({p,s:scoreParts(p,q)}))
      .filter(x=>x.s>0)
      .sort((a,b)=> b.s-a.s || a.p.title.localeCompare(b.p.title))
      .slice(0,20)
      .map(x=>x.p);
    renderSuggestions(sorted);
  },160);
}
const omni=document.getElementById('omniInput');
const results=document.getElementById('searchResults');
omni.addEventListener('keydown',(e)=>{
  if(e.key==='Enter'){
    e.preventDefault();
    const raw=omni.value.trim();
    const val=raw.replace(/\s+/g,'');
    const chk=isCodeLike(val);
    if(chk.ok){ addByCode(chk.code).then(()=>{ omni.value=''; hideSuggestions(); focusOmni(); }); return; }
    const rows=[...results.children];
    if(!results.hidden && rows.length>0){ rows[0].dispatchEvent(new MouseEvent('mousedown',{bubbles:true})); }
    else{ doSearch(raw); }
  }else if(e.key==='Escape'){ hideSuggestions(); }
  else if(e.key==='/'){ e.preventDefault(); focusOmni(); }
});
omni.addEventListener('input', ()=>{
  const q=omni.value.trim();
  if(q.length<1){ hideSuggestions(); return; }
  const d=q.replace(/[^\d]/g,'');
  if(d.length>=8 && d.length<=13){ return; } // probablemente c√≥digo de barras
  doSearch(q);
});
document.addEventListener('click',(e)=>{ if(!results.contains(e.target) && e.target!==omni){ hideSuggestions(); } });

async function addByCode(code){
  const now=Date.now();
  if(lastScan.code===code && (now-lastScan.at)<500) return;
  lastScan={code,at:now};
  const products=await loadProductsCached();
  const p=products.find(r=>r.code===code);
  if(!p){ toast('C√≥digo no encontrado','err'); beepError(); return; }
  if((p.stock||0)<=0 && !document.getElementById('returnMode').checked){
    if(!confirm('Sin stock. ¬øAgregar igualmente?')) return;
  }
  addOrInc(code,p);
}
function addOrInc(code, product){
  const negative=document.getElementById('returnMode').checked;
  const delta=negative? -1 : 1;
  const it=cart.get(code) || {code:product.code,title:product.title,pricePVP:product.pricePVP,qty:0,discType:'none',discValue:0};
  it.qty += delta;
  if(it.qty===0) cart.delete(code); else cart.set(code,it);
  renderCart();
}

/* ===== Outbox simplificado ===== */
function getOutbox(){ try{ return JSON.parse(localStorage.getItem('pos_outbox')||'[]'); }catch{ return []; } }
function setOutbox(a){ try{ localStorage.setItem('pos_outbox', JSON.stringify(a)); }catch{} }
function updateOutboxUI(){ document.getElementById('retryOutboxBtn').style.display = getOutbox().length>0 ? 'inline-flex' : 'none'; }
async function processOutbox(){ const q=getOutbox(); if(q.length===0) return; const rest=[]; for(const s of q){ try{ await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(s)});}catch{rest.push(s);} } setOutbox(rest); updateOutboxUI(); }
setInterval(processOutbox,30000);

/* ===== Cobrar ===== */
async function cobrar(){
  if(cart.size===0){ toast('Carrito vac√≠o','err'); beepError(); focusOmni(); return; }
  const sums=computeTotals();
  let mainMethod=currentMethod||'debito';
  let payments=[];
  if(!splitToggle.checked){
    const cashGiven=readMoney('pagaCon');
    payments.push({method:mainMethod, amount:sums.totalCompra, cashGiven:(mainMethod==='efectivo'?cashGiven:undefined)});
  }else{
    const half=Math.round(sums.totalCompra/2);
    payments.push({method:mainMethod, amount:half});
    payments.push({method:'transferencia', amount:sums.totalCompra-half});
  }
  const items=[...cart.values()].map(it=>({code:it.code,title:it.title,qty:it.qty,priceGross:it.pricePVP,discType:it.discType,discValue:Number(it.discValue||0)}));
  const payload={items,payments,total:sums.totalCompra,discounts:sums.descuentosTotales,returnMode:document.getElementById('returnMode').checked};
  try{
    await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'REGISTER_SALE', sale:payload})});
    cart.clear(); renderCart(); focusOmni(); resetGlobalDiscount(); toast(payload.returnMode?'Cambio registrado ‚úÖ':'Venta registrada ‚úÖ');
  }catch(e){
    const q=getOutbox(); q.push({ts:Date.now(), payload}); setOutbox(q); updateOutboxUI(); toast('Sin conexi√≥n. Venta guardada offline.','err'); beepError();
  }
}

/* ===== Persistencia UI ===== */
function saveUI(){ try{ localStorage.setItem('pos_ui', JSON.stringify({split: document.getElementById('splitToggle')?.checked || false})); }catch{} }
function resetGlobalDiscount({shouldUpdate=true}={}){ 
  const typeEl=document.getElementById('globalDiscType'); 
  const valueEl=document.getElementById('globalDiscValue'); 
  if(!typeEl||!valueEl) return; 
  typeEl.value='percent'; 
  setMoneyValue(valueEl,0); 
  setDiscountModeClass();      // mantener el switch visual
  if(shouldUpdate) updateTotalsUI(); 
}

/* ===== Switch visual del descuento ===== */
function setDiscountModeClass(){
  const seg = document.getElementById('genSeg');
  const mode = document.getElementById('globalDiscType').value;
  seg.classList.toggle('mode-amount', mode === 'amount');
  seg.classList.toggle('mode-percent', mode !== 'amount'); // percent por defecto
}

/* ===== Descuento global ‚Äî UI y auto %/$ ===== */
const genSeg=document.getElementById('genSeg');
genSeg.addEventListener('click',(e)=>{
  if(e.target.tagName!=='BUTTON') return;
  genSeg.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
  e.target.classList.add('active');
  const v=e.target.dataset.v;
  document.getElementById('globalDiscType').value=v;
  setDiscountModeClass();      // <<‚Äî actualiza el switch visual
  updateTotalsUI();
});
const gInput=document.getElementById('globalDiscValue');
gInput.addEventListener('focus',()=>{if(readMoney(gInput)===0){try{gInput.select();}catch{}gInput.value='';}});
gInput.addEventListener('input',()=>{
  const v=readMoney(gInput);
  if(v>100){
    document.getElementById('globalDiscType').value='amount';
    genSeg.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
    genSeg.querySelector('button[data-v="amount"]')?.classList.add('active');
  }else{
    document.getElementById('globalDiscType').value='percent';
    genSeg.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
    genSeg.querySelector('button[data-v="percent"]')?.classList.add('active');
  }
  setDiscountModeClass();      // <<‚Äî actualiza el switch visual
  updateTotalsUI();
});

/* ===== Ayuda & acciones ===== */
document.getElementById('helpOpen').onclick=()=>document.getElementById('helpScrim').style.display='flex';
document.getElementById('helpOpen2').onclick=()=>document.getElementById('helpScrim').style.display='flex';
document.getElementById('helpClose').onclick=()=>document.getElementById('helpScrim').style.display='none';
document.getElementById('finishBtnSticky').addEventListener('click', cobrar);
document.getElementById('retryOutboxBtn')?.addEventListener('click', processOutbox);

/* ===== Init ===== */
function focusOmni(){ const el=document.getElementById('omniInput'); el?.focus(); el?.select?.(); }
loadUI(); renderCart(); focusOmni(); updateOutboxUI(); processOutbox(); attachMoneyFormatters(); setDiscountModeClass();
</script>
</body>
</html>
