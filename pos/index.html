<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Caja (POS) â€” LibrerÃ­a de Fuego (Cloud)</title>
<style>
:root{--bg:#0b0c10;--card:#111318;--muted:#9aa3b2;--text:#e7ecf3}
body{margin:0;background:#0b0c10;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif}
header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#0e1116;border-bottom:1px solid #23262f}
a{color:#fff;text-decoration:none}
main{max-width:900px;margin:0 auto;padding:16px}
.card{background:#111318;border:1px solid #23262f;border-radius:14px;padding:14px}
h1{font-size:18px;margin:0}
h2{font-size:14px;margin:0 0 10px 0}
input,select,button{width:100%;padding:10px;border-radius:10px;border:1px solid #2a2f3a;background:#0f1218;color:#e7ecf3}
button{cursor:pointer;font-weight:600}
.row{display:grid;grid-template-columns:1fr 140px;gap:10px}
table{width:100%;border-collapse:separate;border-spacing:0 8px}
th,td{text-align:left;font-size:12px;padding:8px 10px;border-bottom:1px solid #2a2f3a}
.total{display:flex;justify-content:space-between;align-items:center;font-weight:800;font-size:18px}
</style>
</head>
<body>
<header>
  <h1>ðŸ§¾ Caja (POS) â€” LibrerÃ­a de Fuego</h1>
  <nav><a class="navbtn" href="/inventario/">Ir a Inventario</a> Â· <a class="navbtn" href="/">Inicio</a></nav>
</header>

<main>
  <section class="card">
    <h2>Agregar al carrito</h2>
    <div class="row">
      <input id="scanInput" placeholder="Escanea o escribe cÃ³digo/ISBN">
      <button id="scanBtn">Agregar</button>
    </div>
    <div class="row" style="margin-top:8px">
      <input id="searchTitle" placeholder="Buscar por tÃ­tulo">
      <button id="pickBtn">AÃ±adir</button>
    </div>
  </section>

  <section class="card" style="margin-top:12px">
    <h2>Carrito</h2>
    <table id="cartTable">
      <thead><tr><th>CÃ³digo</th><th>TÃ­tulo</th><th>Cant.</th><th>Neto</th><th>IVA</th><th>Total</th><th></th></tr></thead>
      <tbody></tbody>
    </table>

    <div class="total"><span id="itemsCount">0 Ã­tems</span> <span>Total: $<span id="grandTotal">0</span></span></div>

    <div class="row" style="margin-top:8px">
      <select id="payMethod">
        <option value="efectivo">Efectivo</option><option value="debito">DÃ©bito</option>
        <option value="credito">CrÃ©dito</option><option value="transferencia">Transferencia</option>
      </select>
      <button id="finishBtn">Cobrar / Imprimir</button>
    </div>
    <small class="muted">El stock se descuenta en la nube y queda igual en todos tus dispositivos.</small>
  </section>
</main>

<script>
/* ====== CONFIG ====== */
const API_URL = "https://script.google.com/macros/s/AKfycbz700j5bneZF5-RiJm8lA7Af1vvXcnkwQnrjYbch3hqEuhMUwtgaBpvIztLwR72bakk/exec"; // <-- pega aquÃ­ tu URL /exec

/* ====== Helpers & API ====== */
const IVA=0.19, fmt=n=>new Intl.NumberFormat('es-CL').format(Math.round(n||0));
async function apiGet(action){ const r=await fetch(`${API_URL}?action=${encodeURIComponent(action)}`); return r.json(); }
async function apiPost(action,payload){ const r=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action,...payload})}); return r.json(); }

/* ====== Cloud ====== */
async function cloudGetProducts(){
  const r = await apiGet('LIST_PRODUCTS'); if(!r.ok) throw new Error('LIST_PRODUCTS');
  return r.data.map(p=>({code:p.code,title:p.title,priceNet:Number(p.priceNet||0),stock:Number(p.stock||0)}));
}
async function cloudRegisterSale(sale){
  const r = await apiPost('REGISTER_SALE', { sale }); if(!r.ok) throw new Error('REGISTER_SALE');
  return r.data; // { saleId }
}

/* ====== POS ====== */
const cart=new Map();
function renderCart(){
  const tb=document.querySelector('#cartTable tbody'); tb.innerHTML='';
  let total=0,count=0;
  for(const it of cart.values()){
    const tax=it.priceNet*IVA*it.qty, gross=it.priceNet*(1+IVA)*it.qty;
    total+=gross; count+=it.qty;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${it.code}</td><td>${it.title}</td><td>${it.qty}</td>
                  <td>$${fmt(it.priceNet)}</td><td>$${fmt(tax)}</td><td>$${fmt(gross)}</td>
                  <td><button data-code="${it.code}" class="rm">Quitar</button></td>`;
    tb.appendChild(tr);
  }
  document.getElementById('grandTotal').textContent=fmt(total);
  document.getElementById('itemsCount').textContent=`${count} Ã­tems`;
  tb.querySelectorAll('.rm').forEach(b=> b.onclick=()=>{cart.delete(b.dataset.code);renderCart();});
}

document.getElementById('scanBtn').onclick=async ()=>{
  const c=document.getElementById('scanInput').value.trim(); if(!c) return;
  const products=await cloudGetProducts();
  const p=products.find(r=>r.code===c);
  if(!p){ alert('CÃ³digo no encontrado'); return; }
  if((p.stock||0)<=0 && !confirm('Stock en 0. Â¿Agregar de todos modos?')) return;
  const it=cart.get(c)||{code:p.code,title:p.title,priceNet:p.priceNet,qty:0}; it.qty++; cart.set(c,it); renderCart();
  document.getElementById('scanInput').value='';
};

document.getElementById('pickBtn').onclick=async ()=>{
  const t=document.getElementById('searchTitle').value.trim().toLowerCase(); if(!t) return;
  const products=await cloudGetProducts();
  const p=products.find(r=>(r.title||'').toLowerCase().includes(t));
  if(!p){ alert('No encontrado'); return; }
  if((p.stock||0)<=0 && !confirm('Stock en 0. Â¿Agregar de todos modos?')) return;
  const it=cart.get(p.code)||{code:p.code,title:p.title,priceNet:p.priceNet,qty:0}; it.qty++; cart.set(p.code,it); renderCart();
  document.getElementById('searchTitle').value='';
};

document.getElementById('finishBtn').onclick=async ()=>{
  if(cart.size===0){ alert('Carrito vacÃ­o'); return; }
  let totalNet=0,totalTax=0,total=0,items=[];
  for(const it of cart.values()){
    totalNet+=it.priceNet*it.qty; totalTax+=it.priceNet*IVA*it.qty; total+=it.priceNet*(1+IVA)*it.qty;
    items.push({code:it.code, qty:it.qty, priceNet:it.priceNet, title:it.title});
  }
  const method=document.getElementById('payMethod').value;

  try{
    const resp = await cloudRegisterSale({ items, method, totalNet, totalTax, total });
    const saleId = resp.saleId;

    // Ticket
    const lines=items.map(it=>`${it.qty} x ${it.title} ($${fmt(it.priceNet)} + IVA)`).join('<br>');
    const html=`<!doctype html><html><head><meta charset='utf-8'><title>Ticket</title>
      <style>body{font-family:monospace;padding:8px}h1{font-size:16px;margin:0 0 6px}hr{border:none;border-top:1px dashed #888;margin:6px 0}</style>
      </head><body><h1>LibrerÃ­a de Fuego</h1>
      <div>Ticket #${saleId} â€” ${new Date().toLocaleString('es-CL')}</div><hr>${lines}<hr>
      <div>Neto: $${fmt(totalNet)}</div><div>IVA (19%): $${fmt(totalTax)}</div><div><b>Total: $${fmt(total)}</b></div>
      <div>Pago: ${method}</div><hr><small>Gracias por tu compra</small></body></html>`;
    const w=window.open('','_blank','width=420,height=600'); w.document.write(html); w.document.close(); w.print();

    cart.clear(); renderCart();
    alert('Venta registrada en la nube âœ…');
  }catch(err){
    alert('Error registrando venta: ' + err.message);
  }
};

renderCart();
</script>
</body>
</html>
