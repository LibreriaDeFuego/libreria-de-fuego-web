<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Caja (POS) — Librería de Fuego — Papel & Tinta</title>
<style>
:root{
  /* 🎉 Fiesta Vibrante */
  --bg:#FFF9EB;          /* fondo durazno claro */
  --ink:#1F1A17;         /* texto más contrastado */
  --sepia:#6A3B2E;       /* marrón cálido */
  --terra:#FF6B4A;       /* coral / botón principal */
  --green:#00B37E;       /* verde celebración */
  --line:#FFE3C7;        /* borde suave */
  --muted:#7A6A60;       /* texto suave */
  --card:#FFFFFF;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
h1,h2,h3{margin:0 0 10px}
a{color:var(--terra);text-decoration:none}
button{cursor:pointer;font-weight:600;border-radius:12px;border:1px solid var(--line);background:#fff;color:var(--ink);padding:10px 12px}
button.primary{background:var(--terra);color:#fff;border-color:#C45F2F}
button.green{background:var(--green);color:#fff;border-color:#276946}
button.ghost{background:#fff;color:var(--sepia)}
button:disabled{opacity:.6;cursor:not-allowed}

.container{max-width:1200px;margin:0 auto;padding:16px}
header .brand{font-size:20px;font-weight:800;letter-spacing:.2px}

/* Two-column layout */
.grid{display:grid;gap:14px;grid-template-columns: 1.2fr .8fr}
@media (max-width: 980px){ .grid{grid-template-columns:1fr} }
  
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 6px 20px rgba(0,0,0,.04)}
.card h2{font-size:16px}

/* Left column blocks */
.omniWrap{position:relative}
.omniWrap input{width:100%;padding:14px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;color:var(--ink);font-size:16px}
.suggestBox{
  position:absolute;left:0;right:0;top:56px;background:#fff;border:1px solid var(--line);border-radius:12px;
  max-height:360px;overflow:auto;z-index:9999;box-shadow:0 10px 24px rgba(0,0,0,.08)
}
.suggestItem{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px;border-radius:10px;cursor:pointer}
.suggestItem:hover,.suggestItem.active{background:#FFF1D7} /* durazno suave */
.left{display:flex;align-items:center;gap:10px;min-width:0}
.cover{width:42px;height:60px;border-radius:10px;object-fit:cover;background:#EEE;border:1px solid #E8E1D9;flex:0 0 auto}
.no-cover{width:42px;height:60px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:#EEE;color:#777;font-weight:700}
.meta{display:flex;flex-direction:column;gap:2px;min-width:0}
.meta .t{font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.meta .a{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.meta .p{font-size:12px;color:var(--sepia)}
.stock{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid var(--line)}
.stock.good{background:#EFF7F1;border-color:#D5E9DB;color:#246744}
.stock.none{background:#FCEDEA;border-color:#F2C7BB;color:#9A3C1D}

.small{font-size:12px;color:var(--muted)}

table{width:100%;border-collapse:separate;border-spacing:0 8px}
th,td{text-align:left;font-size:12px;padding:10px;border-bottom:1px dashed var(--line);vertical-align:middle}
td input[type="number"],
td input[data-a="discValue"]{padding:8px;border-radius:10px;border:1px solid var(--line);background:#fff;color:var(--ink);width:100%}

.seg{display:inline-flex;border:1px solid var(--line);border-radius:10px;overflow:hidden}
.seg button{padding:8px 10px;background:#fff;border:0;color:var(--ink);width:auto}
.seg button + button{border-left:1px solid var(--line)}
.seg button.active{background:#FFE3BD} /* durazno pastel */

.row-selected{background:#FFF4EE}

/* Right column: Cobro */
.totalBlock{display:flex;flex-direction:column;gap:8px}
.totalDisplay{font-size:22px;font-weight:800;color:var(--ink)}
.badges{display:flex;gap:8px;flex-wrap:wrap}
.badge{background:#FFF4CC;border:1px solid #FFDCA3;color:#7A3E00;border-radius:999px;padding:6px 10px;font-size:12px}
.vueltoXL{ font-size:20px; font-weight:800; letter-spacing:0.2px; }
.line{display:flex;align-items:center;gap:8px}

/* Sticky bar */
.stickyBar{
  position:fixed;left:0;right:0;bottom:0;z-index:9000;display:flex;align-items:center;justify-content:space-between;gap:8px;
  background:rgba(250,247,242,.9);backdrop-filter:saturate(1.1) blur(6px);border-top:1px solid var(--line);padding:10px 12px
}

/* Toasts */
#toasts{position:fixed;right:12px;bottom:74px;display:flex;flex-direction:column;gap:8px;z-index:9500}
.toast{background:#FFFFFF;border:1px solid var(--line);color:var(--ink);padding:10px 12px;border-radius:10px;font-size:14px;box-shadow:0 10px 20px rgba(0,0,0,.08)}
.toast.err{border-color:#E7B2A3;background:#FFF4EE;color:#7E2E17}

/* Modal (confirm + ayuda) */
.modalScrim{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9600}
.modal{background:#fff;border:1px solid var(--line);border-radius:14px;max-width:520px;width:92%;padding:16px;box-shadow:0 20px 40px rgba(0,0,0,.12)}
.modal h3{margin:0 0 6px;font-size:18px}
.modal p{margin:0 0 12px;color:var(--sepia)}
.modal .row{display:flex;gap:8px;justify-content:flex-end}

kbd{background:#FFF1E9;border:1px solid #EEC8B3;border-radius:6px;padding:2px 6px;font-size:12px}
hr.sep{border:none;border-top:1px dashed var(--line);margin:10px 0}

/* --- Nav links & layout --- */
.topbar .leftBar{ display:flex; align-items:center; gap:12px; flex-wrap:wrap }
.navLinks{ display:flex; gap:8px; flex-wrap:wrap }
.navLinks a{ padding:6px 10px; border:1px solid var(--line); border-radius:10px; font-size:13px; color:var(--ink); background:#fff }
.navLinks a:hover{ background:#FFF4EE }

/* --- Equal width segmented buttons (% / $ / sin) --- */
.seg button{ display:inline-flex; align-items:center; justify-content:center; min-width:40px; height:34px; padding:0 10px; line-height:1; }

/* --- Row separator aligned across the entire row --- */
table{ width:100%; border-collapse:separate; border-spacing:0 8px }
th,td{ border-bottom:none } /* remove per-cell borders */
#cartTable thead th{ border-bottom:1px dashed var(--line) } /* keep header underline */
#cartTable tbody tr{ position:relative }
#cartTable tbody tr::after{
  content:""; position:absolute; left:0; right:0; bottom:-4px;
  border-top:1px dashed var(--line);
}

/* --- Bodega panel list --- */
.bodegaList{ display:flex; flex-direction:column; gap:8px; }
.bodegaList .bitem{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px; border:1px dashed var(--line); border-radius:10px; background:#fff }
.bodegaList .bitem .t{ font-weight:600 }


/* === Ensure Cobro card is sticky on the right === */
.stickySide{ position:sticky; top:12px; align-self:start; max-height:calc(100vh - 24px); overflow:auto }
@media (max-width: 980px){
  .cobroCard{ order:-1; position:sticky; top:10px; z-index:10 }
}
/* Keep bottom stickyBar hidden to avoid duplication */
.stickyBar{ display:none }

/* --- Equal halves only for global discount segmented control --- */
#genSeg{ display:inline-flex; width:110px; } /* fixed comfortable width for two equal halves */
#genSeg button{ flex:1 1 0; min-width:0; height:36px; padding:0; line-height:1; }


/* === Per-line discount segmented control (Detalle de venta) === */
#cartTable .seg[data-line]{ display:flex; flex:0 0 120px; max-width:120px }
#cartTable .seg[data-line] button{ flex:1 1 0; min-width:0; height:34px; padding:0; line-height:1; }

/* Keep the number input compact so column fits nicely */
#cartTable td input[data-a="discValue"]{ max-width:90px }

/* === Vertical centering for tall rows (long titles) === */
#cartTable tbody td{ vertical-align:middle }
#cartTable tbody td .line{ align-items:center }  /* center flex children vertically */

/* Optional: ensure +/- controls are consistent */
#cartTable tbody td .line button.ghost{ height:34px; display:inline-flex; align-items:center; justify-content:center; border-radius:999px }


/* === Collapsible left sidebar (icons -> labels on hover) === */
.sideDock{
  position:fixed; left:0; top:0; bottom:0; width:56px; background:#FFFFFF;
  border-right:1px solid var(--line); z-index:9100; padding:10px 6px; display:flex;
  flex-direction:column; gap:8px; transition:width .18s ease;
  box-shadow:0 10px 24px rgba(0,0,0,.04);
}
.sideDock:hover{ width:200px }
.sideDock .dockItem{
  display:flex; align-items:center; gap:12px; padding:10px; border-radius:12px; color:var(--ink);
  border:1px solid transparent; text-decoration:none; white-space:nowrap;
}
.sideDock .dockItem:hover{ background:#FFF4EE; border-color:#EEC8B3 }
.sideDock .ico{ font-size:18px; width:24px; text-align:center }
.sideDock .lbl{ opacity:0; transition:opacity .16s; }
.sideDock:hover .lbl{ opacity:1 }

/* Push main container to the right so sidebar doesn't overlap */
.container{ margin-left:72px }

/* Hide old header nav links */
.navLinks{ display:none !important }

/* === Per-line discount segment equal thirds + wider input === */
#cartTable .seg[data-line]{
  display:grid; grid-template-columns:repeat(3, 1fr); width:150px; min-width:150px; max-width:150px;
}
#cartTable .seg[data-line] button{ height:34px; padding:0; line-height:1; }
#cartTable td input[data-a="discValue"]{
  width:120px; max-width:120px;
}

/* === Vertical centering for 'Cantidad' cells and row content === */
#cartTable tbody td{ vertical-align:middle }
#cartTable tbody td.line{ display:flex; align-items:center }


/* === FIX: Vertical centering for 'Cantidad' column even with tall rows === */
#cartTable tbody td.line{
  display:table-cell !important; /* revert from flex to table-cell for equal row height */
  vertical-align:middle !important;
  text-align:center;
  white-space:nowrap;
}
#cartTable tbody td.line span{ display:inline-block; margin:0 8px; }
#cartTable tbody td.line button.ghost{
  height:34px; display:inline-flex; align-items:center; justify-content:center; border-radius:999px;
}

/* Ensure discount value input never collapses */
#cartTable td input[type="number"][data-a="discValue"]{ width:120px; min-width:120px; max-width:140px }

 /* === UI: Pay cards & cash strip (Puntos 1,4,5,6,9) === */
.payCard{border:1px solid var(--line);border-radius:16px;background:#fff;padding:12px;box-shadow:0 6px 16px rgba(0,0,0,.03);margin-top:8px}
.payHead{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.payHead .title{font-weight:800}
.cashStrip{background:#FFF8E5;border:1px dashed var(--line);border-radius:12px;padding:10px}
.methodBadge{background:#FFF4CC;border:1px solid #FFDCA3;color:#7A3E00;border-radius:999px;padding:6px 10px;font-size:12px}
 
</style>
</head>
<body>

<!-- Collapsible icon sidebar -->
<aside class="sideDock" aria-label="Navegación principal">
  <a href="inventario.html" class="dockItem" title="Inventario"><span class="ico">📚</span><span class="lbl">Inventario</span></a>
  <a href="reportes.html" class="dockItem" title="Reportes"><span class="ico">📊</span><span class="lbl">Reportes</span></a>
  <a href="bodega.html" class="dockItem" title="Bodega"><span class="ico">🏷️</span><span class="lbl">Bodega</span></a>
</aside>

<div class="container">
  <header class="topbar" style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
    <div class="leftBar">
      <div class="brand">🧾 Caja (POS) — Librería de Fuego</div>
      <nav class="navLinks">
        <a href="inventario.html">📚 Inventario</a>
        <a href="reportes.html">📊 Reportes</a>
        <a href="bodega.html">🏷️ Bodega</a>
      </nav>
    </div>
    <div class="small">Ayuda <button id="helpOpen" class="ghost" title="Atajos y ayuda">?</button></div>
  </header>

  <section class="grid">
    <!-- LEFT: productos & carrito -->
    <div class="card">
      <h2>Detalle de venta</h2>
      <div class="omniWrap" style="margin-top:8px">
        <input id="omniInput" placeholder="Escanea o escribe título, autor o código" autocomplete="off" aria-autocomplete="list" aria-controls="searchResults" aria-expanded="false" aria-haspopup="listbox">
        <div id="searchResults" class="suggestBox" role="listbox" hidden></div>
      </div>

      <div class="line small" style="margin-top:8px">
        <label class="line" title="Si activas Modo cambio, las cantidades se agregan negativas (devuelve stock)">
          <input id="returnMode" type="checkbox" style="width:auto;margin-right:6px"> Modo cambio / devolución
        </label>
        <span>• Doble clic fila: +1 • Alt+clic: −1 • Supr: quitar • <kbd>/</kbd> enfoca búsqueda</span>
      </div>

      <hr class="sep">

      <table id="cartTable" aria-label="Carrito de venta">
        <thead>
          <tr>
            <th style="width:110px">Código</th>
            <th>Título</th>
            <th style="width:140px">Cantidad</th>
            <th style="width:120px">PVP</th>
            <th style="width:300px">Descuento</th>
            <th style="width:120px">Total</th>
            <th style="width:70px"></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="line" style="margin-top:8px;justify-content:flex-end;flex-wrap:wrap;gap:10px">
        <button id="retryOutboxBtn" class="ghost" style="display:none" title="Reenviar ventas pendientes">Reintentar pendientes</button>
        <button id="clearBtn" class="ghost">Vaciar</button>
      </div>
    
    <!-- LEFT: sugerencias de bodega -->
    <div class="card" id="bodegaPanel">
      <h2>🏷️ Bodega (reposiciones sugeridas)</h2>
      <p class="small">Cuando vendas, aquí verás lo que conviene traer desde bodega.</p>
      <div id="bodegaList" class="bodegaList">Sin sugerencias por ahora</div>
      <div class="line" style="justify-content:flex-end;margin-top:8px">
        <a class="ghost" href="bodega.html" title="Abrir página de Bodega">Abrir página de Bodega →</a>
      </div>
    </div>

</div>

    <!-- RIGHT: cobro -->
    <div class="card cobroCard">
  <div style="display:flex;align-items:center;justify-content:space-between">
    <h2>💳 COBRO</h2>
    <button id="menuCobro" style="background:none;border:none;font-size:20px;cursor:pointer">⋮</button>
  </div>

  <div class="line" style="margin-top:10px;flex-wrap:wrap">
    <label class="small" style="width:100%">Descuento</label>
    <div class="seg" id="genSeg">
      <button type="button" data-v="amount">$</button>
      <input id="globalDiscValue" type="text" inputmode="numeric" value="0"
        style="width:80px;text-align:center;border:0;background:#fff;color:#000;font-weight:700" data-format="money">
      <button type="button" data-v="percent">%</button>
    </div>
    <input id="globalDiscType" type="hidden" value="percent">
  </div>

  <div class="line" style="margin-top:16px;justify-content:center">
    <div style="background:#537BFF;color:#fff;padding:12px 20px;border-radius:16px;text-align:center;font-size:22px;font-weight:800">
      Total <br> $<span id="grandTotal">0</span>
    </div>
  </div>

  <hr class="sep">

  <label class="small">Método de pago</label>
  <div class="line" style="flex-wrap:wrap;gap:6px">
    <button class="payBtn" data-method="debito">DÉBITO</button>
    <button class="payBtn" data-method="credito">CRÉDITO</button>
    <button class="payBtn" data-method="transferencia">TRANSFERENCIA</button>
    <button class="payBtn" data-method="efectivo">EFECTIVO</button>
  </div>

  <div id="efectivoBox" style="display:none;margin-top:10px">
    <label class="small">PAGA CON</label>
    <input id="pagaCon" type="text" inputmode="numeric" value="0" data-format="money" style="max-width:140px">
    <label class="small" style="margin-top:6px">VUELTO</label>
    <div style="font-size:20px;font-weight:700" id="vueltoDisplay">$0</div>
  </div>

  <hr class="sep">

  <div class="line" style="align-items:center;justify-content:space-between">
    <label class="small">Pago dividido</label>
    <input type="checkbox" id="splitToggle" style="transform:scale(1.4)">
  </div>
  <div id="splitBar" style="height:6px;width:100%;border-radius:10px;background:linear-gradient(to right,#537BFF 100%,#FF70D7 0%)"></div>

  <hr class="sep">

  <button id="saveCartBtn" class="ghost" style="width:100%">Guardar carro</button>
</div>

      <hr class="sep">

      <!-- Totales -->
      <div class="totalBlock">
        <div class="totalDisplay">Total: $<span id="grandTotal">0</span></div>
        <div class="badges">
          <span class="badge">Ítems: <span id="itemsCount">0</span></span>
          <span class="badge">Descuentos totales: $<span id="sumAllDiscounts">0</span></span>
        </div>
      </div>

      <hr class="sep">

<hr class="sep">

      <div class="line" style="justify-content:flex-end;gap:8px;flex-wrap:wrap">
        <button id="reprintBtn" class="ghost" title="Reimprimir último ticket">Reimprimir</button>
        <button id="finishBtn" class="green">Cobrar / Ticket</button>
      </div>
    </div>
  </section>
</div>

<!-- Sticky total bar -->
<div class="stickyBar" id="stickyBar" aria-live="polite">
  <div><b>Total:</b> $<span id="grandTotalSticky">0</span> — <span id="itemsCountSticky">0 ítems</span></div>
  <div class="line">
    <button id="finishBtnSticky" class="green">Cobrar / Ticket</button>
    <button id="helpOpen2" class="ghost" title="Ver atajos y ayuda">?</button>
  </div>
</div>

<!-- Toasts -->
<div id="toasts" aria-live="polite" aria-atomic="true"></div>

<!-- Confirm modal -->
<div class="modalScrim" id="confirmScrim" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
  <div class="modal">
    <h3 id="confirmTitle">Confirmar</h3>
    <p id="confirmMsg">¿Seguro?</p>
    <div class="row">
      <button id="confirmCancel" class="ghost">Cancelar</button>
      <button id="confirmOk" class="primary">Aceptar</button>
    </div>
  </div>
</div>

<!-- Help modal (trial) -->
<div class="modalScrim" id="helpScrim" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
  <div class="modal">
    <h3 id="helpTitle">Ayuda rápida</h3>
    <p>
      <kbd>Enter</kbd> agrega el primer resultado • <kbd>Esc</kbd> cierra sugerencias •
      Doble clic en fila: +1 • <kbd>Alt</kbd>+clic: −1 • <kbd>Supr</kbd>: quitar fila •
      <kbd>/</kbd> enfoca la búsqueda. (Modo prueba)
    </p>
    <div class="row">
      <button id="helpClose" class="ghost">Cerrar</button>
    </div>
  </div>
</div>

<script>
/* ====== CONFIG ====== */
const API_URL = "https://script.google.com/macros/s/AKfycbz700j5bneZF5-RiJm8lA7Af1vvXcnkwQnrjYbch3hqEuhMUwtgaBpvIztLwR72bakk/exec";

/* ====== Helpers ====== */
const IVA=0.19; // para convertir neto->PVP si viene como neto
const fmt=n=>new Intl.NumberFormat('es-CL').format(Math.round(n||0));
const digitsOnly=v=>(v||'').toString().replace(/\D/g,'');
function readMoney(elOrId){
  const el=typeof elOrId==='string'?document.getElementById(elOrId):elOrId;
  if(!el) return 0;
  const d=digitsOnly(el.value);
  return d?Number(d):0;
}
function setMoneyValue(elOrId, value){
  const el=typeof elOrId==='string'?document.getElementById(elOrId):elOrId;
  if(!el) return;
  const n=Math.max(0, Math.round(Number(value)||0));
  el.value=fmt(n);
}
function formatMoneyInput(el){
  if(!el) return;
  const d=digitsOnly(el.value);
  if(!d){ el.value=''; return; }
  el.value=fmt(Number(d));
}
function attachMoneyFormatters(root=document){
  const scope = root instanceof Element ? root : document;
  scope.querySelectorAll('input[data-format="money"]').forEach(el=>{
    if(el.dataset.moneyBound==='1') return;
    formatMoneyInput(el);
    if(el.value===''){ el.value='0'; }
    el.addEventListener('focus', ()=>{
      if(readMoney(el)===0){ el.value=''; }
      setTimeout(()=>{ try{ el.setSelectionRange(el.value.length, el.value.length); }catch{} },0);
    });
    el.addEventListener('blur', ()=>{
      formatMoneyInput(el);
      if(el.value===''){ el.value='0'; }
    });
    el.addEventListener('input', ()=>{
      const d=digitsOnly(el.value);
      el.value=d?fmt(Number(d)):'';
      setTimeout(()=>{ try{ el.setSelectionRange(el.value.length, el.value.length); }catch{} },0);
    });
    el.dataset.moneyBound='1';
  });
}
  
/* ====== Beep (solo error) ====== */
let audioCtx=null;
function ensureAudio(){ if(!audioCtx){ try{ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }catch{} } }
function beepError(){
  ensureAudio(); if(!audioCtx) return;
  const o=audioCtx.createOscillator(), g=audioCtx.createGain();
  const now=audioCtx.currentTime;
  o.frequency.setValueAtTime(280, now);
  g.gain.setValueAtTime(0.0001, now);
  g.gain.exponentialRampToValueAtTime(0.25, now+0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, now+0.18);
  o.connect(g); g.connect(audioCtx.destination);
  o.start(now); o.stop(now+0.2);
}

/* ====== Toasts ====== */
function toast(msg, kind='ok', timeout=2400){
  const box=document.getElementById('toasts');
  const el=document.createElement('div');
  el.className='toast '+(kind==='err'?'err':'');
  el.textContent=msg;
  box.appendChild(el);
  setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(6px)'; }, timeout-180);
  setTimeout(()=>{ box.removeChild(el); }, timeout);
}

/* ====== Confirm ====== */
function confirmBox(message){
  return new Promise(res=>{
    const scrim=document.getElementById('confirmScrim');
    document.getElementById('confirmMsg').textContent=message||'¿Seguro?';
    scrim.style.display='flex';
    const ok=()=>{ cleanup(); res(true); };
    const cancel=()=>{ cleanup(); res(false); };
    function cleanup(){
      okBtn.removeEventListener('click',ok);
      cancelBtn.removeEventListener('click',cancel);
      scrim.style.display='none';
    }
    const okBtn=document.getElementById('confirmOk');
    const cancelBtn=document.getElementById('confirmCancel');
    okBtn.addEventListener('click', ok);
    cancelBtn.addEventListener('click', cancel);
  });
}

/* ====== API ====== */
async function apiGet(action){
  const r=await fetch(`${API_URL}?action=${encodeURIComponent(action)}`,{mode:'cors',credentials:'omit'});
  return r.json();
}
async function apiPost(action,payload){
  const r=await fetch(API_URL,{
    method:'POST',mode:'cors',credentials:'omit',
    headers:{'Content-Type':'text/plain;charset=utf-8'},
    body:JSON.stringify({action,...payload})
  });
  return r.json();
}

/* ====== Cache productos ====== */
const CACHE_TTL_MS = 10*60*1000;
let productCache = null;
(function initCache(){
  try{
    const raw = localStorage.getItem('pos_products_cache');
    if(raw){ const {ts,arr}=JSON.parse(raw); productCache={ts,arr}; }
  }catch{}
})();
async function loadProductsCached(){
  try{
    if(productCache && (Date.now()-productCache.ts)<CACHE_TTL_MS) return productCache.arr;
    const arr = await cloudGetProducts();
    productCache = {ts:Date.now(), arr};
    try{ localStorage.setItem('pos_products_cache', JSON.stringify(productCache)); }catch{}
    return arr;
  }catch(err){
    toast('No se pudo cargar productos (LIST_PRODUCTS).','err'); beepError(); throw err;
  }
}

/* ====== Normalización campos nube ====== */
function getAuthorField(p){
  let a = p.author ?? p.autor ?? p.autores ?? p.Author ?? p.Autor ?? p.authors ?? p.writer ?? p.creador ?? p.creators ?? '';
  if(Array.isArray(a)) a = a.map(x => (x?.name||x)).join(', ');
  if(a && typeof a === 'object') a = a.name || a.fullname || a.display || '';
  return String(a||'');
}
function getCoverField(p){
  let c = p.cover ?? p.image ?? p.coverUrl ?? p.portada ?? p.portadaUrl ?? p.thumbnail ?? '';
  return String(c||'');
}
async function cloudGetProducts(){
  const r = await apiGet('LIST_PRODUCTS'); if(!r.ok) throw new Error('LIST_PRODUCTS');
  return r.data.map(p=>({
    code  : String(p.code),
    title : String(p.title||p.Titulo||p.titulo||'Sin título'),
    author: getAuthorField(p),
    cover : getCoverField(p),
    pricePVP: Number(p.priceNet||0) * (1+IVA),
    stock : Number(p.stock||p.Stock||0)
  }));
}
async function cloudRegisterSale(sale){
  const r = await apiPost('REGISTER_SALE', { sale });
  if(!r.ok) throw new Error(r?.message || 'REGISTER_SALE');
  return r.data; // { saleId }
}

/* ====== Estado POS ====== */
const cart=new Map();
let selectedCode=null;
let lastTicketHTML='';
let lastScan = {code:'', at:0};
function focusOmni(){ const el=document.getElementById('omniInput'); el?.focus(); el?.select?.(); }

/* ====== Persistencia UI ====== */
function saveUI(){
  try{
    localStorage.setItem('pos_ui', JSON.stringify({
      pay1: document.getElementById('payMethod1').value,
      pay2: document.getElementById('payMethod2')?.value || 'debito',
      split: document.getElementById('splitToggle').checked
    }));
  }catch{}
}
  function resetGlobalDiscount({shouldUpdate=true}={}){
  const typeEl = document.getElementById('globalDiscType');
  const valueId = 'globalDiscValue';
  const valueEl = document.getElementById(valueId);
  if(!typeEl || !valueEl) return;
  typeEl.value = 'percent';
  setMoneyValue(valueEl, 0);
  document.querySelectorAll('#genSeg button').forEach(b=>{
    b.classList.toggle('active', b.dataset.v==='percent');
  });
  if(shouldUpdate) updateTotalsUI();
}
function loadUI(){
let u=null;
  try{ u = JSON.parse(localStorage.getItem('pos_ui')||'null'); }
  catch{}
  if(u){
    document.getElementById('payMethod1').value = u.pay1 || 'efectivo';
    const pm2 = document.getElementById('payMethod2'); if(pm2) pm2.value = u.pay2 || 'debito';
    document.getElementById('splitToggle').checked = !!u.split;
    document.getElementById('splitSection').style.display = u.split ? 'block' : 'none';
}
  resetGlobalDiscount({shouldUpdate:false});
  updateTotalsUI();
}
  
/* ====== Cálculos SOBRE PVP ====== */
function computeLine(it){
  const unit = Number(it.pricePVP||0);
  const qty  = Number(it.qty||0);
  let unitAfter = unit;
  if(it.discType==='percent'){
    unitAfter = unit * (1 - (Number(it.discValue||0)/100));
  }else if(it.discType==='amount'){
    unitAfter = Math.max(0, unit - Number(it.discValue||0));
  }
  const base = unit * qty;
  const descLine = base - unitAfter * qty;
  const total = unitAfter * qty;
  return {unit, unitAfter, base, descLine, total};
}

function computeTotals(){
  let subtotal=0, descLineas=0;
  for(const it of cart.values()){
    const c = computeLine(it);
    subtotal += c.total;
    descLineas += c.descLine;
  }
  const type = document.getElementById('globalDiscType').value;
  const val  = readMoney('globalDiscValue');
  let descGeneral = 0;
  if(type==='percent') descGeneral = subtotal * (val/100);
  else if(type==='amount') descGeneral = Math.min(subtotal, val);
  const descuentosTotales = Math.max(0, descLineas + descGeneral);
  const totalCompra = Math.max(0, subtotal - descGeneral);
  return { subtotal, descLineas, descGeneral, descuentosTotales, totalCompra };
}

function updateTotalsUI(){
  const t=computeTotals();
  document.getElementById('sumAllDiscounts').textContent=fmt(t.descuentosTotales);
  document.getElementById('grandTotal').textContent=fmt(t.totalCompra);
  document.getElementById('grandTotalSticky').textContent=fmt(t.totalCompra);
  const count = Array.from(cart.values()).reduce((a,it)=>a+Math.abs(it.qty),0);
  document.getElementById('itemsCount').textContent=fmt(count);
  document.getElementById('itemsCountSticky').textContent=`${fmt(count)} ítems`;
  updateChangeDisplays();
  saveUI();
}

/* ====== Render ====== */
function renderCart(){
  const tb=document.querySelector('#cartTable tbody'); tb.innerHTML='';
  for(const it of cart.values()){
    const c=computeLine(it);
    const tr=document.createElement('tr');
    tr.title='Doble clic: +1 • Alt+clic: −1 • Supr: quitar';
    tr.dataset.code = it.code;
    tr.innerHTML=`
      <td>${it.code}</td>
      <td>${it.title}</td>
      <td class="line" style="gap:6px">
        <button data-a="dec" data-code="${it.code}" class="ghost" style="padding:6px 10px">−</button>
        <span>${it.qty}</span>
        <button data-a="inc" data-code="${it.code}" class="ghost" style="padding:6px 10px">+</button>
      </td>
      <td>$${fmt(it.pricePVP)}</td>
      <td>
        <div class="line" style="gap:6px;justify-content:flex-end">
          <div class="seg" data-line="${it.code}">
            <button type="button" data-a="discType" data-v="percent" class="${it.discType==='percent'?'active':''}">%</button>
            <button type="button" data-a="discType" data-v="amount"  class="${it.discType==='amount'?'active':''}">$</button>
            <button type="button" data-a="discNone"  class="${it.discType==='none'?'active':''}">sin</button>
          </div>
          <input type="text" inputmode="numeric" value="${it.discValue||0}" data-a="discValue" data-code="${it.code}" data-format="money" style="max-width:110px" />
        </div>
      </td>
      <td class="lineTotal">$${fmt(c.total)}</td>
      <td><button data-a="del" data-code="${it.code}" class="ghost">Quitar</button></td>`;
    attachMoneyFormatters(tr);
    tb.appendChild(tr);

    tr.onclick = (ev)=>{
      document.querySelectorAll('#cartTable tbody tr').forEach(r=>r.classList.remove('row-selected'));
      tr.classList.add('row-selected'); selectedCode=it.code;
      if(ev.altKey){ const item=cart.get(it.code); if(item){ item.qty--; if(item.qty===0) cart.delete(it.code); renderCart(); } }
    };
    tr.ondblclick=()=>{ const item=cart.get(it.code); if(item){ item.qty++; renderCart(); } };
  }
  // botones inc/dec/del
  tb.querySelectorAll('button').forEach(b=>{
    const code=b.dataset.code, a=b.dataset.a;
    b.onclick=()=>{
      const it=cart.get(code); if(!it) return;
      if(a==='inc') it.qty++;
      if(a==='dec') it.qty = (document.getElementById('returnMode').checked ? it.qty-1 : Math.max(0,it.qty-1));
      if(a==='del') cart.delete(code);
      if(it.qty===0) cart.delete(code);
      renderCart();
    };
  });
  // tipo descuento por línea
  tb.querySelectorAll('.seg[data-line]').forEach(seg=>{
    seg.addEventListener('click',(e)=>{
      if(e.target.tagName!=='BUTTON') return;
      const code = seg.dataset.line;
      const it = cart.get(code); if(!it) return;
      const act = e.target.dataset.a;
      seg.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
      e.target.classList.add('active');
      if(act==='discType'){
        it.discType = e.target.dataset.v;
        if(!it.discValue) it.discValue = (it.discType==='percent'?1:100);
      }else if(act==='discNone'){
        it.discType='none'; it.discValue=0;
      }
      const row = seg.closest('tr');
      const c = computeLine(it);
      row.querySelector('.lineTotal').textContent = '$'+fmt(c.total);
      updateTotalsUI();
    });
  });
  // valor descuento
  // valor descuento
tb.querySelectorAll('input[data-a="discValue"]').forEach(el=>{
  el.oninput = ()=>{
    const code = el.dataset.code;
    const it   = cart.get(code);
    if(!it) return;

    const val  = Math.max(0, readMoney(el));
    it.discValue = val;

    // 👉 NUEVO: aquí la magia
    const seg = el.closest('tr')?.querySelector('.seg[data-line]');

    // Si no hay tipo de descuento aún y escribe algo
    if(it.discType === 'none' && val > 0){
      it.discType = (val > 100) ? 'amount' : 'percent';
      if(seg){
        seg.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
        seg.querySelector(`button[data-v="${it.discType==='amount'?'amount':'percent'}"]`)?.classList.add('active');
      }
    }

    // Si ya estaba en % y pasa de 100, forzar a $
    if(it.discType === 'percent' && val > 100){
      it.discType = 'amount';
      if(seg){
        seg.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
        seg.querySelector('button[data-v="amount"]')?.classList.add('active');
      }
    }

    // Si vuelve a 0, quitar el descuento
    if(val === 0){
      it.discType = 'none';
      if(seg){
        seg.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
        seg.querySelector('button[data-a="discNone"]')?.classList.add('active');
      }
    }

    const row = el.closest('tr');
    const c   = computeLine(it);
    row.querySelector('.lineTotal').textContent = '$' + fmt(c.total);
    updateTotalsUI();
  };
});


  updateTotalsUI();
}

/* ====== Omnibox & búsqueda ====== */
const omni = document.getElementById('omniInput');
const results = document.getElementById('searchResults');
let suggIndex=-1;
function hideSuggestions(){ results.hidden = true; suggIndex=-1; omni.setAttribute('aria-expanded','false'); }
function showSuggestions(){ results.hidden = false; omni.setAttribute('aria-expanded','true'); }

const norm = s => (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();

// checksums
function ean13valid(d){
  if(!/^\d{13}$/.test(d)) return false;
  const a = d.split('').map(Number);
  const sum = a.slice(0,12).reduce((acc,n,i)=> acc + (i%2? n*3 : n), 0);
  const check = (10 - (sum % 10)) % 10;
  return check === a[12];
}
function ean8valid(d){
  if(!/^\d{8}$/.test(d)) return false;
  const a = d.split('').map(Number);
  const sum = a.slice(0,7).reduce((acc,n,i)=> acc + (i%2? n*3 : n), 0);
  const check = (10 - (sum % 10)) % 10;
  return check === a[7];
}
function isCodeLike(s){
  const d = s.replace(/[^\d]/g,'');
  if(/^97[89]\d{10}$/.test(d) && ean13valid(d)) return {ok:true, code:d};
  if(/^\d{13}$/.test(d) && ean13valid(d)) return {ok:true, code:d};
  if(/^\d{12}$/.test(d)) return {ok:true, code:d};
  if(/^\d{8}$/.test(d) && ean8valid(d)) return {ok:true, code:d};
  return {ok:false};
}

// scoring
function lev(a,b){
  a=norm(a); b=norm(b);
  const m=a.length, n=b.length; if(m===0) return n; if(n===0) return m;
  const dp=new Array(n+1); for(let j=0;j<=n;j++) dp[j]=j;
  for(let i=1;i<=m;i++){
    let prev=dp[0], cur; dp[0]=i;
    for(let j=1;j<=n;j++){
      const cost = a[i-1]===b[j-1] ? 0 : 1;
      cur = Math.min(dp[j]+1, dp[j-1]+1, prev+cost);
      prev = dp[j]; dp[j]=cur;
    }
  }
  return dp[n];
}
function scoreParts(p, q){
  const T=norm(p.title), A=norm(p.author), Q=norm(q);
  let titleScore = 0, authorScore = 0;
  if(T.startsWith(Q)) titleScore += 100; else if(T.includes(Q)) titleScore += 70;
  if(A.startsWith(Q)) authorScore+= 100; else if(A.includes(Q)) authorScore+= 70;
  const dt = lev(T.slice(0,32), Q.slice(0,32)); if(dt<=2) titleScore += (50 - dt*10);
  const da = lev(A.slice(0,32), Q.slice(0,32)); if(da<=2) authorScore+= (50 - da*10);
  const total = Math.max(titleScore, authorScore);
  return {total};
}
function stockBadge(p){
  const s = Number(p.stock||0);
  if(s<=0) return '<span class="stock none">Sin stock</span>';
  return `<span class="stock good">Stock: ${s}</span>`;
}
function renderSuggestions(list){
  results.innerHTML = '';
  if(list.length===0){ hideSuggestions(); return; }
  list.forEach((p, i)=>{
    const row = document.createElement('div');
    row.className = 'suggestItem' + (i===suggIndex ? ' active' : '');
    row.setAttribute('role','option');
    const left = document.createElement('div'); left.className='left';
    let coverEl;
    if(p.cover){ coverEl = document.createElement('img'); coverEl.className='cover'; coverEl.src=p.cover; coverEl.alt=p.title; }
    else{ coverEl = document.createElement('div'); coverEl.className='no-cover'; coverEl.textContent=(p.title||'?').slice(0,1).toUpperCase(); }
    const meta = document.createElement('div'); meta.className='meta';
    meta.innerHTML = `
      <div class="t">${p.title||'Sin título'}</div>
      <div class="a">${p.author||'Autor desconocido'}</div>
      <div class="p">$${fmt(p.pricePVP)}</div>
    `;
    left.appendChild(coverEl); left.appendChild(meta);
    row.appendChild(left);
    const right = document.createElement('div'); right.innerHTML = stockBadge(p);
    row.appendChild(right);
    row.onmousedown = (e)=>{ e.preventDefault(); addOrInc(p.code, p); hideSuggestions(); omni.value=''; focusOmni(); };
    results.appendChild(row);
  });
  showSuggestions();
}

let searchTimer=null;
async function doSearch(q){
  clearTimeout(searchTimer);
  searchTimer = setTimeout(async ()=>{
    const products = await loadProductsCached();
    const sorted = products
      .map(p=>({p, s: scoreParts(p, q).total}))
      .filter(x=>x.s>0)
      .sort((a,b)=> b.s - a.s || a.p.title.localeCompare(b.p.title))
      .slice(0, 20)
      .map(x=>x.p);
    renderSuggestions(sorted);
  }, 160);
}
omni.addEventListener('keydown',(e)=>{
  if(e.key==='Enter'){
    e.preventDefault();
    const raw = omni.value.trim();
    const val = raw.replace(/\s+/g,'');
    const chk = isCodeLike(val);
    if(chk.ok){
      addByCode(chk.code).then(()=>{ omni.value=''; hideSuggestions(); focusOmni(); });
      return;
    }
    const rows = Array.from(results.children);
    if(!results.hidden && rows.length>0){
      rows[0].dispatchEvent(new MouseEvent('mousedown',{bubbles:true}));
    }else{
      doSearch(raw);
    }
  }else if(e.key==='Escape'){ hideSuggestions(); }
  else if(e.key==='/'){ e.preventDefault(); focusOmni(); }
});
omni.addEventListener('input', ()=>{
  const q = omni.value.trim();
  if(q.length<1){ hideSuggestions(); return; }
  const d = q.replace(/[^\d]/g,'');
  if(d.length>=8 && d.length<=13){ return; }
  doSearch(q);
});
document.addEventListener('click',(e)=>{ if(!results.contains(e.target) && e.target!==omni){ hideSuggestions(); } });

async function addByCode(code){
  const now = Date.now();
  if(lastScan.code===code && (now - lastScan.at) < 500) { return; }
  lastScan = {code, at: now};
  const products=await loadProductsCached();
  const p=products.find(r=>r.code===code);
  if(!p){ toast('Código no encontrado','err'); beepError(); return; }
  if((p.stock||0)<=0 && !document.getElementById('returnMode').checked){
    const ok = await confirmBox('Sin stock. ¿Agregar igualmente?');
    if(!ok) return;
  }
  addOrInc(code, p);
}
function addOrInc(code, product){
  const negative = document.getElementById('returnMode').checked;
  const delta = negative ? -1 : 1;
  const it = cart.get(code) || {code:product.code,title:product.title,pricePVP:product.pricePVP,qty:0,discType:'none',discValue:0};
  it.qty += delta;
  if (it.qty === 0) { cart.delete(code); } else { cart.set(code,it); }
  renderCart();
}


/* ====== Split auto-complete helpers ====== */
let lastEditedSplit = 'amount1';

/* ====== Bodega panel (simple suggestions based on current cart) ====== */
function updateBodegaPanel(){
  const box = document.getElementById('bodegaList'); if(!box) return;
  const items = [];
  for(const it of cart.values()){
    const qty = Math.max(0, it.qty);
    if(qty>0){
      items.push({code:it.code, title:it.title, qty});
    }
  }
  if(items.length===0){
    box.textContent = 'Sin sugerencias por ahora';
    return;
  }
  box.innerHTML = items.map(x => (
    `<div class="bitem">
      <div><div class="t">${x.title}</div><div class="small">Código: ${x.code}</div></div>
      <button class="ghost" data-bcode="${x.code}" data-bqty="${x.qty}">Traer ${x.qty}</button>
    </div>`
  )).join('');
  box.querySelectorAll('button[data-bcode]').forEach(btn=>{
    btn.onclick = ()=>{
      toast('Marcado para reposición desde bodega');
    };
  });
}

/* ====== Pago & vuelto ====== */
  /* === UI: Badges de método con iconos (Punto 9) === */
function updateMethodBadges(){
  const map = { efectivo:'💵 Efectivo', debito:'💳 Débito', credito:'💳 Crédito', transferencia:'🔁 Transferencia' };
  const b1 = document.getElementById('methodBadge1');
  const b2 = document.getElementById('methodBadge2');
  if(b1){ const m1 = document.getElementById('payMethod1').value; b1.textContent = map[m1] || 'Método'; }
  if(b2){ const m2 = document.getElementById('payMethod2').value; b2.textContent = map[m2] || 'Método'; }
}

function updateChangeDisplays(){
  const total = computeTotals().totalCompra;
  const method1 = document.getElementById('payMethod1').value;
  const split = document.getElementById('splitToggle').checked;
  updateMethodBadges();
  const cashBox1 = document.getElementById('cashBox1');
  const cashBox2 = document.getElementById('cashBox2');
  cashBox1.style.display = (method1==='efectivo') ? 'flex' : 'none';
  if(!split){
    const given1 = readMoney('cashGiven1');
    const change1 = Math.max(0, (method1==='efectivo' ? given1 : 0) - total);
    document.getElementById('cashChange1').textContent=fmt(change1);
    document.getElementById('splitSection').style.display='none';
    return;
  }
  document.getElementById('splitSection').style.display='block';
  const method2 = document.getElementById('payMethod2').value;
  cashBox2.style.display = (method2==='efectivo') ? 'flex' : 'none';
  const a1 = Math.max(0, readMoney('amount1'));
  const a2 = Math.max(0, readMoney('amount2'));
  const g1 = readMoney('cashGiven1');
  const g2 = readMoney('cashGiven2');
  document.getElementById('cashChange1').textContent = fmt(method1==='efectivo' ? Math.max(0, g1 - (a1 || 0)) : 0);
  document.getElementById('cashChange2').textContent = fmt(method2==='efectivo' ? Math.max(0, g2 - (a2 || 0)) : 0);
}

/* ====== Ticket (simple HTML) ====== */
function buildTicketHTML(saleId, items, sums, payments, isReturn){
  const lines = items.map(it=>{
    const {unitAfter} = computeLine(it);
    const d = it.discType==='percent' ? ` (-${it.discValue}% )` :
              it.discType==='amount'  ? ` (-$${fmt(it.discValue)} c/u)` : '';
    return `${it.qty} x ${it.title} — $${fmt(unitAfter)}${d}`;
  }).join('<br>');

  const title = isReturn ? 'Ticket de Cambio' : 'Ticket de Venta';
  const payText = payments.map(p=> `${p.method}: $${fmt(p.amount)}${p.cashGiven?` (paga con $${fmt(p.cashGiven)})`:''}`).join(' · ');

  return `<!doctype html><html><head><meta charset='utf-8'><title>${title}</title>
    <style>body{font-family:monospace;padding:8px}h1{font-size:16px;margin:0 0 6px}
    hr{border:none;border-top:1px dashed #888;margin:6px 0}</style></head>
    <body>
      <h1>Librería de Fuego</h1>
      <div>${title} #${saleId} — ${new Date().toLocaleString('es-CL')}</div>
      <hr>${lines}<hr>
      <div>Descuentos totales: $${fmt(sums.descuentosTotales)}</div>
      <div><b>Total de compra: $${fmt(sums.totalCompra)}</b></div>
      <div>Pago: ${payText}</div>
      <hr><small>Gracias por tu compra</small>
    </body></html>`;
}

/* ====== Outbox offline ====== */
function getOutbox(){ try{ return JSON.parse(localStorage.getItem('pos_outbox')||'[]'); }catch{ return []; } }
function setOutbox(arr){ try{ localStorage.setItem('pos_outbox', JSON.stringify(arr)); }catch{} }
function updateOutboxUI(){
  const count = getOutbox().length;
  document.getElementById('retryOutboxBtn').style.display = count>0 ? 'inline-flex' : 'none';
}
async function processOutbox(){
  const q = getOutbox();
  if(q.length===0) return;
  const remaining=[];
  for(const sale of q){
    try{ await cloudRegisterSale(sale.payload); }
    catch{ remaining.push(sale); }
  }
  setOutbox(remaining); updateOutboxUI();
}
setInterval(processOutbox, 30000);
document.getElementById('retryOutboxBtn')?.addEventListener('click', processOutbox);

/* ====== Cobrar ====== */
async function cobrar(){
  if(cart.size===0){ toast('Carrito vacío','err'); beepError(); focusOmni(); return; }
  const sums = computeTotals();
  const split = document.getElementById('splitToggle').checked;
  let payments=[];
  const m1 = document.getElementById('payMethod1').value;
  if(!split){
    const cash1 = readMoney('cashGiven1');
    payments.push({method:m1, amount:sums.totalCompra, cashGiven:(m1==='efectivo'?cash1:undefined)});
  }else{
    const m2 = document.getElementById('payMethod2').value;
    const a1 = Math.max(0, readMoney('amount1'));
    const a2 = Math.max(0, readMoney('amount2'));
    const cash1 = readMoney('cashGiven1');
    const cash2 = readMoney('cashGiven2');
    const sum = a1 + a2;
    if(Math.abs(sum - sums.totalCompra) > 1){
      toast('La suma de montos (pago dividido) debe ser igual al Total de compra.','err'); beepError(); return;
    }
    payments.push({method:m1, amount:a1, cashGiven:(m1==='efectivo'?cash1:undefined)});
    payments.push({method:m2, amount:a2, cashGiven:(m2==='efectivo'?cash2:undefined)});
  }

  const items=[]; for(const it of cart.values()){
    items.push({code:it.code,title:it.title,qty:it.qty,priceGross:it.pricePVP,discType:it.discType,discValue:Number(it.discValue||0)});
  }
  const payload = { items, payments, total: sums.totalCompra, discounts: sums.descuentosTotales, returnMode: document.getElementById('returnMode').checked };

  try{
    const resp = await cloudRegisterSale(payload);
    const saleId = resp.saleId || ('LOCAL-' + Date.now());
    const html = buildTicketHTML(saleId, items, sums, payments, payload.returnMode);
    lastTicketHTML = html;
    const w=window.open('','_blank','width=430,height=640'); w.document.write(html); w.document.close(); w.print();
    cart.clear(); renderCart(); focusOmni();
    resetGlobalDiscount();
    toast(payload.returnMode ? 'Cambio registrado ✅' : 'Venta registrada ✅');
  }catch(err){
    const q = getOutbox();
    q.push({ts:Date.now(), payload});
    setOutbox(q); updateOutboxUI();
    toast('Sin conexión. Venta guardada offline.','err'); beepError();
  }
}
document.getElementById('finishBtn').onclick=cobrar;
document.getElementById('finishBtnSticky').onclick=cobrar;
document.getElementById('reprintBtn').onclick=()=>{
  if(!lastTicketHTML){ toast('Aún no hay ticket para reimprimir','err'); beepError(); return; }
  const w=window.open('','_blank','width=430,height=640'); w.document.write(lastTicketHTML); w.document.close(); w.print();
};

/* ====== Eventos generales ====== */
document.getElementById('clearBtn').onclick=async ()=>{
  const ok = await confirmBox('¿Vaciar el carrito?');
  if(ok){ cart.clear(); renderCart(); focusOmni(); toast('Carrito vacío'); }
};
document.addEventListener('keydown',(e)=>{
  if(e.key==='Delete' && selectedCode){ cart.delete(selectedCode); selectedCode=null; renderCart(); toast('Ítem eliminado'); }
});
// descuento general
const genSeg=document.getElementById('genSeg');
genSeg.addEventListener('click',(e)=>{
  if(e.target.tagName!=='BUTTON') return;
  genSeg.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
  e.target.classList.add('active');
  const v=e.target.dataset.v; document.getElementById('globalDiscType').value=v;
  updateTotalsUI();
});
// Improved global discount input: clear '0' on focus and auto-switch to $ if >100
const gInput = document.getElementById('globalDiscValue');
gInput.addEventListener('focus', ()=>{ if(readMoney(gInput)===0){ try{ gInput.select(); }catch{} gInput.value=''; } });
gInput.addEventListener('input', ()=>{
  const v = readMoney(gInput);
  if(v > 100){
    document.getElementById('globalDiscType').value = 'amount';
    genSeg.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
    const amtBtn = genSeg.querySelector('button[data-v="amount"]');
    if(amtBtn) amtBtn.classList.add('active');
  }
  updateTotalsUI();
});

/* === NUEVO: Lógica visual y funcional del panel de Cobro === */
let currentMethod = null;

document.querySelectorAll('.payBtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.payBtn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    currentMethod = btn.dataset.method;
    const efectivoBox = document.getElementById('efectivoBox');
    efectivoBox.style.display = (currentMethod === 'efectivo') ? 'block' : 'none';
    updateVuelto();
  });
});

document.getElementById('pagaCon').addEventListener('input', updateVuelto);
function updateVuelto(){
  const total = computeTotals().totalCompra;
  const pago = readMoney('pagaCon');
  const vuelto = Math.max(0, pago - total);
  document.getElementById('vueltoDisplay').textContent = '$' + fmt(vuelto);
}

const splitToggle = document.getElementById('splitToggle');
splitToggle.addEventListener('change', ()=>{
  const bar = document.getElementById('splitBar');
  if(!splitToggle.checked){
    bar.style.background = 'linear-gradient(to right,#537BFF 100%,#FF70D7 0%)';
  } else {
    bar.style.background = 'linear-gradient(to right,#537BFF 50%,#FF70D7 50%)';
  }
});

document.getElementById('saveCartBtn').addEventListener('click', ()=>{
  if(cart.size===0){ toast('No hay productos en el carro','err'); beepError(); return; }
  const data = Array.from(cart.values());
  try{
    localStorage.setItem('saved_cart', JSON.stringify(data));
    toast('Carro guardado ✅');
  }catch{
    toast('Error al guardar','err'); beepError();
  }
});

document.getElementById('menuCobro').addEventListener('click', ()=>{
  toast('Menú de opciones (en desarrollo)');
});  
// split toggle
document.getElementById('splitToggle').addEventListener('change', ()=>{
  const total = Math.round(computeTotals().totalCompra);
  setMoneyValue('amount1', total);
  setMoneyValue('amount2', 0);
  updateChangeDisplays(); saveUI();
});
['payMethod1','cashGiven1','payMethod2','cashGiven2','amount1','amount2'].forEach(id=>{
  const el=document.getElementById(id);
  el?.addEventListener('input', updateChangeDisplays);
  el?.addEventListener('change', saveUI);
});
  
/* ====== Ayuda (trial) ====== */
function openHelp(){ document.getElementById('helpScrim').style.display='flex'; }
function closeHelp(){ document.getElementById('helpScrim').style.display='none'; }
document.getElementById('helpOpen').onclick=openHelp;
document.getElementById('helpOpen2').onclick=openHelp;
document.getElementById('helpClose').onclick=closeHelp;
document.addEventListener('keydown', e=>{ if(e.key==='?' && !e.shiftKey){ openHelp(); }});

// Inicial
loadUI(); renderCart(); focusOmni(); updateOutboxUI(); processOutbox();
attachMoneyFormatters();
updateChangeDisplays();  


/* === Wire split amount auto-completion === */
document.getElementById('amount1')?.addEventListener('input', ()=>{
  lastEditedSplit='amount1';
  syncSplitFromA1();
});
document.getElementById('amount2')?.addEventListener('input', ()=>{
  lastEditedSplit='amount2';
  syncSplitFromA2();
});

/* Ajustar funciones de sincronización para redondear también */
function syncSplitFromA1(){
  if(!document.getElementById('splitToggle').checked) return;
  const total = Math.round(computeTotals().totalCompra);
  const a1El = document.getElementById('amount1');
  const a2El = document.getElementById('amount2');
  const a1 = Math.floor(readMoney(a1El));
  setMoneyValue(a2El, Math.max(0, total - a1));
  updateChangeDisplays();
}
function syncSplitFromA2(){
  if(!document.getElementById('splitToggle').checked) return;
  const total = Math.round(computeTotals().totalCompra);
  const a1El = document.getElementById('amount1');
  const a2El = document.getElementById('amount2');
  const a2 = Math.floor(readMoney(a2El));
  setMoneyValue(a1El, Math.max(0, total - a2));
  updateChangeDisplays();
}


/* Re-sync when totals change (e.g., cart or discounts) */
const _updateTotalsUI_orig = updateTotalsUI;
updateTotalsUI = function(){
  _updateTotalsUI_orig();
  if(document.getElementById('splitToggle').checked){
    if(lastEditedSplit==='amount1') syncSplitFromA1(); else syncSplitFromA2();
  }
  updateBodegaPanel();
};

/* Also refresh Bodega panel after cart renders */
const _renderCart_orig = renderCart;
renderCart = function(){
  _renderCart_orig();
  updateBodegaPanel();
};


/* === UX: per-line discount inputs ===
   - Clear preset '0' when focusing the discount value box
   - If value > 100 and current type is %, auto-switch to $
   - If type is 'none' and user types a value, switch to % (<=100) or $ (>100)
*/
(function(){
  const tbody = document.querySelector('#cartTable tbody');
  if(!tbody) return;

  tbody.addEventListener('focusin', (e)=>{
    const el = e.target;
    if(el && el.matches('input[data-a="discValue"]')){
       if(readMoney(el) === 0){ try{ el.select(); }catch{} el.value = ''; }
    }
  });

  tbody.addEventListener('input', (e)=>{
    const el = e.target;
    if(!(el && el.matches('input[data-a="discValue"]'))) return;
    const code = el.dataset.code;
    const it = cart.get(code);
    if(!it) return;

    const val = readMoney(el);
    if(it.discType === 'none' && val > 0){
      const seg = el.closest('tr')?.querySelector('.seg[data-line]');
      if(val > 100){
        it.discType = 'amount';
        if(seg){
          seg.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
          seg.querySelector('button[data-v="amount"]').classList.add('active');
        }
      }else{
        it.discType = 'percent';
        if(seg){
          seg.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
          seg.querySelector('button[data-v="percent"]').classList.add('active');
        }
      }
    }else if(it.discType === 'percent' && val > 100){
      it.discType = 'amount';
      const seg = el.closest('tr')?.querySelector('.seg[data-line]');
      if(seg){
        seg.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
        seg.querySelector('button[data-v="amount"]').classList.add('active');
      }
    }
    updateTotalsUI();
  });
})();
</script>
</body>
</html>
