<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>POS â€” LibrerÃ­a de Fuego</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #0b0c10;
      color: #e7ecf3;
    }
    header {
      background: #111318;
      padding: 10px;
      text-align: center;
      font-weight: bold;
    }
    main {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      padding: 16px;
    }
    section {
      flex: 1;
      min-width: 300px;
      background: #1a1c22;
      padding: 12px;
      border-radius: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }
    th, td {
      border: 1px solid #333;
      padding: 6px;
      font-size: 12px;
    }
    button {
      padding: 6px 10px;
      margin-top: 6px;
      cursor: pointer;
      background: #ff6a00;
      color: white;
      border: none;
      border-radius: 4px;
    }
    input, select {
      width: 100%;
      padding: 6px;
      margin-top: 4px;
    }
    .total {
      font-size: 16px;
      font-weight: bold;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <header>
    ðŸ”¥ POS â€” LibrerÃ­a de Fuego
  </header>

  <main>
    <!-- Inventario -->
    <section>
      <h2>Inventario</h2>
      <input id="invSearch" placeholder="Buscar por tÃ­tulo o cÃ³digo">
      <br>
      <input id="p_code" placeholder="CÃ³digo / ISBN">
      <input id="p_title" placeholder="TÃ­tulo">
      <input id="p_author" placeholder="Autor / Editorial">
      <input id="p_stock" type="number" placeholder="Stock">
      <input id="p_price" type="number" placeholder="Precio Neto">
      <button id="addBtn">Agregar / Actualizar</button>

      <table id="invTable">
        <thead>
          <tr>
            <th>CÃ³digo</th><th>TÃ­tulo</th><th>Stock</th><th>Neto</th><th>Bruto</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Caja -->
    <section>
      <h2>Caja</h2>
      <input id="scanInput" placeholder="CÃ³digo / ISBN">
      <button id="scanBtn">Agregar</button>
      <input id="searchTitle" placeholder="Buscar por tÃ­tulo">
      <button id="pickBtn">AÃ±adir</button>

      <table id="cartTable">
        <thead>
          <tr>
            <th>CÃ³digo</th><th>TÃ­tulo</th><th>Cant.</th><th>Neto</th><th>IVA</th><th>Total</th><th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="total">Total: $<span id="grandTotal">0</span></div>
      <select id="payMethod">
        <option value="efectivo">Efectivo</option>
        <option value="debito">DÃ©bito</option>
        <option value="credito">CrÃ©dito</option>
        <option value="transferencia">Transferencia</option>
      </select>
      <button id="finishBtn">Cobrar / Imprimir</button>
    </section>
  </main>

<script>
  const IVA = 0.19;
  const fmt = n => new Intl.NumberFormat('es-CL').format(Math.round(n||0));

  // --- Base de datos en localStorage ---
  function getProducts(){ return JSON.parse(localStorage.getItem('products')||'[]'); }
  function saveProducts(arr){ localStorage.setItem('products', JSON.stringify(arr)); }
  function getSales(){ return JSON.parse(localStorage.getItem('sales')||'[]'); }
  function saveSales(arr){ localStorage.setItem('sales', JSON.stringify(arr)); }

  // --- Inventario ---
  function refreshInventory(filter=''){
    const tbody = document.querySelector('#invTable tbody');
    tbody.innerHTML = '';
    let rows = getProducts();
    if(filter){
      const f = filter.toLowerCase();
      rows = rows.filter(r=>r.title.toLowerCase().includes(f)||r.code.includes(f));
    }
    for(const p of rows){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${p.code}</td><td>${p.title}</td><td>${p.stock}</td>
                      <td>$${fmt(p.priceNet)}</td><td>$${fmt(p.priceNet*(1+IVA))}</td>`;
      tbody.appendChild(tr);
    }
  }

  document.querySelector('#addBtn').onclick = ()=>{
    const code = document.querySelector('#p_code').value.trim();
    const title = document.querySelector('#p_title').value.trim();
    if(!code || !title) return alert('Falta cÃ³digo o tÃ­tulo');
    const author = document.querySelector('#p_author').value.trim();
    const stock = Number(document.querySelector('#p_stock').value||0);
    const priceNet = Number(document.querySelector('#p_price').value||0);
    let rows = getProducts();
    const i = rows.findIndex(r=>r.code===code);
    if(i>=0) rows[i] = {...rows[i], title, author, stock, priceNet};
    else rows.push({code,title,author,stock,priceNet});
    saveProducts(rows);
    refreshInventory();
  };
  document.querySelector('#invSearch').oninput = e=>refreshInventory(e.target.value);

  // --- POS / Carrito ---
  const cart = new Map();
  function renderCart(){
    const tbody = document.querySelector('#cartTable tbody');
    tbody.innerHTML='';
    let total=0;
    for(const it of cart.values()){
      const tax=it.priceNet*IVA*it.qty, gross=it.priceNet*(1+IVA)*it.qty;
      total+=gross;
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${it.code}</td><td>${it.title}</td>
      <td>${it.qty}</td><td>$${fmt(it.priceNet)}</td>
      <td>$${fmt(tax)}</td><td>$${fmt(gross)}</td>
      <td><button onclick=\"cart.delete('${it.code}');renderCart();\">Quitar</button></td>`;
      tbody.appendChild(tr);
    }
    document.querySelector('#grandTotal').textContent=fmt(total);
  }
  document.querySelector('#scanBtn').onclick=()=>{
    const code=document.querySelector('#scanInput').value.trim();
    if(!code) return;
    const p=getProducts().find(r=>r.code===code);
    if(!p) return alert('No encontrado');
    const it=cart.get(code)||{...p,qty:0};
    it.qty++; cart.set(code,it); renderCart();
    document.querySelector('#scanInput').value='';
  };
  document.querySelector('#pickBtn').onclick=()=>{
    const t=document.querySelector('#searchTitle').value.trim().toLowerCase();
    if(!t) return;
    const p=getProducts().find(r=>r.title.toLowerCase().includes(t));
    if(!p) return alert('No encontrado');
    const it=cart.get(p.code)||{...p,qty:0};
    it.qty++; cart.set(p.code,it); renderCart();
    document.querySelector('#searchTitle').value='';
  };

  document.querySelector('#finishBtn').onclick=()=>{
    if(cart.size===0) return alert('Carrito vacÃ­o');
    let totalNet=0,totalTax=0,total=0,items=[];
    for(const it of cart.values()){
      totalNet+=it.priceNet*it.qty;
      totalTax+=it.priceNet*IVA*it.qty;
      total+=it.priceNet*(1+IVA)*it.qty;
      items.push(it);
    }
    const sales=getSales();
    const id=(sales.at(-1)?.id||0)+1;
    const sale={id,date:new Date().toISOString(),items,totalNet,totalTax,total,method:document.querySelector('#payMethod').value};
    sales.push(sale); saveSales(sales);
    // Descontar stock
    let rows=getProducts();
    for(const it of items){
      const i=rows.findIndex(r=>r.code===it.code);
      if(i>=0) rows[i].stock=Math.max(0,rows[i].stock-it.qty);
    }
    saveProducts(rows); refreshInventory();
    // Imprimir ticket
    let lines=items.map(it=>`${it.qty} x ${it.title} ($${fmt(it.priceNet)} + IVA)`);
    let html=`<!doctype html><html><head><meta charset='utf-8'><title>Ticket</title></head><body>
    <h1>LibrerÃ­a de Fuego</h1>
    <div>Ticket #${id} â€” ${new Date().toLocaleString('es-CL')}</div><hr>
    ${lines.join('<br>')}
    <hr><div>Neto: $${fmt(totalNet)}</div>
    <div>IVA: $${fmt(totalTax)}</div>
    <div><b>Total: $${fmt(total)}</b></div>
    <div>Pago: ${sale.method}</div><hr>
    <small>Gracias por tu compra</small>
    </body></html>`;
    const w=window.open('','_blank','width=400,height=600');
    w.document.write(html); w.document.close(); w.print();
    cart.clear(); renderCart();
  };

  // Init
  refreshInventory();
</script>
</body>
</html>
